<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Parameterizing Soybean-BioCro • BioCroValidation</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Parameterizing Soybean-BioCro">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    padding-top: 70px;

    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">BioCroValidation</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/BioCroValidation.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/parameterizing_soybean_biocro.html">Parameterizing Soybean-BioCro</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/BioCro/BioCroValidation/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Parameterizing Soybean-BioCro</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/BioCro/BioCroValidation/blob/v0.2.0/vignettes/parameterizing_soybean_biocro.Rmd" class="external-link"><code>vignettes/parameterizing_soybean_biocro.Rmd</code></a></small>
      <div class="d-none name"><code>parameterizing_soybean_biocro.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This article shows how to create an objective function that can be
used to parameterize BioCro’s soybean model <span class="citation">(<a href="#ref-matthews_soybean_biocro_2021">Matthews et al. 2021</a>; <a href="#ref-lochocki_biocro_2022">Lochocki et al. 2022</a>)</span>.</p>
<p>Since the original publication of Soybean-BioCro, the BioCro module
library has undergone several changes, and the model has been
re-parameterized several times. These parameterizations did not use
<code>BioCroValidation</code>, since they were performed before
<code>BioCroValidation</code> was created.</p>
<p>However, <code>BioCroValidation</code> is able to re-create the
objective functions that were used for these parameterizations. Here, we
re-create the objective function that was used for the parameterization
included in version <code>3.2.0</code> of the BioCro R package.</p>
<p>In the commands below, we will use functions from several libraries,
so we will load them now:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load required libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/BioCro/BioCroValidation" class="external-link">BioCroValidation</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/biocro/biocro" class="external-link">BioCro</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">dfoptim</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lattice.r-forge.r-project.org/" class="external-link">lattice</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="building-the-objective-function">Building the Objective Function<a class="anchor" aria-label="anchor" href="#building-the-objective-function"></a>
</h2>
<p>In this section, we will use the <code>objective_function</code>
function from <code>BioCroValidation</code> package to create an
objective function that can be used to parameterize Soybean-BioCro. For
more details about this, please see the help page for
<code>objective_function</code> by typing
<code><a href="../reference/objective_function.html">?objective_function</a></code> from an R terminal.</p>
<div class="section level3">
<h3 id="the-base-model-definition">The Base Model Definition<a class="anchor" aria-label="anchor" href="#the-base-model-definition"></a>
</h3>
<p>We first need a base model definition that includes the necessary
modules, initial values, parameters, and differential equation solver
specifications. For this example, we will simply use Soybean-BioCro as
the base model, with just one small change: we will use an Euler solver
rather than the default solver, which will help make the optimization
run faster. For reasonable sets of parameter values, the Euler solver
does not seem to cause any substantial errors when running
Soybean-BioCro.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Specify the base model definition</span></span>
<span><span class="va">base_model_definition</span>            <span class="op">&lt;-</span> <span class="va">soybean</span></span>
<span><span class="va">base_model_definition</span><span class="op">$</span><span class="va">ode_solver</span> <span class="op">&lt;-</span> <span class="va">default_ode_solvers</span><span class="op">[[</span><span class="st">'homemade_euler'</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-observed-data">The Observed Data<a class="anchor" aria-label="anchor" href="#the-observed-data"></a>
</h3>
<p>The observed data needed to parameterize Soybean-BioCro is included
in the <code>BioCroValidation</code> package as the
<code>soyface_biomass</code> data set, which consists of two years (2002
and 2005) of biomass data and associated standard deviations, included
in four separate tables. However, each table requires some
pre-processing to get it ready.</p>
<p>One issue is that the data set specifies the doy of year (DOY) for
each harvest, but we need to specify the time using BioCro’s convention
(the number of hours since the start of the year).</p>
<p>Another issue is that the data set includes pod and seed values, but
Soybean-BioCro calculates shell and seed masses, where the shell and
seed together comprise the pod.</p>
<p>Although the observations do not include root biomass, it is
nevertheless important to constrain the predicted root mass to
reasonable values. To do this, it is assumed that the maximum root mass
is seventeen percent of the maximum aboveground biomass, and that it is
achieved at the same time as maximum above-ground biomass, based on
observations reported in <span class="citation">Ordóñez et al. (<a href="#ref-ordonez_root_2020">2020</a>)</span>. In the observed data,
the sum of stem and leaf mass is largest at the fifth time point in both
years. So, root mass is estimated at this single time point and added to
the observed values.</p>
<p>In previous parameterizations, a standard deviation for the root mass
was not explicitly estimated; instead, the standard-deviation-based
weight factor was implicitly set to 1. Because the
<code>'logarithm'</code> method with <span class="math inline">\(\epsilon = 10^{-5}\)</span> was used, a weight
factor of 1 implies a standard deviation of <span class="math inline">\(1 / e - 10^{-5} \approx 0.3678694\)</span>. See
the documentation page (<code><a href="../reference/objective_function.html">?objective_function</a></code>) for more
information about this weighting method.</p>
<p>Finally, the data set includes some values that are not needed for
the parameterization. This includes the leaf litter accumulated between
each harvest, as well as the <code>DOY</code> and
<code>Rep_Mg_per_ha</code> columns that have been superseded by other
columns defined above.</p>
<p>Here we will define a helping function that can accomplish the
required modifications described above; note that some operations are
different depending on whether the table represents biomass values or
standard deviations:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define a helping function for processing data tables</span></span>
<span><span class="va">process_table</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_table</span>, <span class="va">type</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Define new `time` column</span></span>
<span>  <span class="va">data_table</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">data_table</span><span class="op">$</span><span class="va">DOY</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">24.0</span></span>
<span></span>
<span>  <span class="co"># Define new `Shell_Mg_per_ha` column</span></span>
<span>  <span class="va">data_table</span><span class="op">$</span><span class="va">Shell_Mg_per_ha</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">'biomass'</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># The shell is all parts of the pod other than the seed</span></span>
<span>    <span class="va">data_table</span><span class="op">$</span><span class="va">Rep_Mg_per_ha</span> <span class="op">-</span> <span class="va">data_table</span><span class="op">$</span><span class="va">Seed_Mg_per_ha</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># Add uncertainties in quadrature, a simple approach to error propagation</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">data_table</span><span class="op">$</span><span class="va">Rep_Mg_per_ha</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">data_table</span><span class="op">$</span><span class="va">Seed_Mg_per_ha</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Define new `Root_Mg_per_ha` column, which has just one non-NA value</span></span>
<span>  <span class="va">row_to_use</span> <span class="op">&lt;-</span> <span class="fl">5</span>                 <span class="co"># Choose row to use</span></span>
<span>  <span class="va">data_table</span><span class="op">$</span><span class="va">Root_Mg_per_ha</span> <span class="op">&lt;-</span> <span class="cn">NA</span> <span class="co"># Initialize all values to NA</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">'biomass'</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Estimate a mass at one time point</span></span>
<span>    <span class="va">col_to_add</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">'Leaf_Mg_per_ha'</span>,</span>
<span>      <span class="st">'Stem_Mg_per_ha'</span>,</span>
<span>      <span class="st">'Rep_Mg_per_ha'</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="va">data_table</span><span class="op">[</span><span class="va">row_to_use</span>, <span class="st">'Root_Mg_per_ha'</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>      <span class="fl">0.17</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_table</span><span class="op">[</span><span class="va">row_to_use</span>, <span class="va">col_to_add</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># Estimate standard deviation at one time point</span></span>
<span>    <span class="va">data_table</span><span class="op">[</span><span class="va">row_to_use</span>, <span class="st">'Root_Mg_per_ha'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1e-5</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Remove columns by setting them to NULL</span></span>
<span>  <span class="va">data_table</span><span class="op">$</span><span class="va">DOY</span>              <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="va">data_table</span><span class="op">$</span><span class="va">Rep_Mg_per_ha</span>    <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="va">data_table</span><span class="op">$</span><span class="va">Litter_Mg_per_ha</span> <span class="op">=</span> <span class="cn">NULL</span></span>
<span></span>
<span>  <span class="co"># Return the processed table</span></span>
<span>  <span class="va">data_table</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-data-driver-pairs">The Data-Driver Pairs<a class="anchor" aria-label="anchor" href="#the-data-driver-pairs"></a>
</h3>
<p>The <code>BioCro</code> R package includes weather data for the years
in the <code>soyface_biomass</code> data set. So now we are ready to
define the data-driver pairs, which includes the weather, the observed
biomass, the standard deviation of the observed biomass, and the weight
to assign to each year:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define the data-driver pairs</span></span>
<span><span class="va">data_driver_pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  ambient_2002 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    data       <span class="op">=</span> <span class="fu">process_table</span><span class="op">(</span><span class="va">soyface_biomass</span><span class="op">[[</span><span class="st">'ambient_2002'</span><span class="op">]</span><span class="op">]</span>,     <span class="st">'biomass'</span><span class="op">)</span>,</span>
<span>    data_stdev <span class="op">=</span> <span class="fu">process_table</span><span class="op">(</span><span class="va">soyface_biomass</span><span class="op">[[</span><span class="st">'ambient_2002_std'</span><span class="op">]</span><span class="op">]</span>, <span class="st">'stdev'</span><span class="op">)</span>,</span>
<span>    drivers    <span class="op">=</span> <span class="fu">BioCro</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/BioCro/man/cmi_soybean_weather_data.html" class="external-link">soybean_weather</a></span><span class="op">[[</span><span class="st">'2002'</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    weight     <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span>,</span>
<span>  ambient_2005 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    data       <span class="op">=</span> <span class="fu">process_table</span><span class="op">(</span><span class="va">soyface_biomass</span><span class="op">[[</span><span class="st">'ambient_2005'</span><span class="op">]</span><span class="op">]</span>,     <span class="st">'biomass'</span><span class="op">)</span>,</span>
<span>    data_stdev <span class="op">=</span> <span class="fu">process_table</span><span class="op">(</span><span class="va">soyface_biomass</span><span class="op">[[</span><span class="st">'ambient_2005_std'</span><span class="op">]</span><span class="op">]</span>, <span class="st">'stdev'</span><span class="op">)</span>,</span>
<span>    drivers    <span class="op">=</span> <span class="fu">BioCro</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/BioCro/man/cmi_soybean_weather_data.html" class="external-link">soybean_weather</a></span><span class="op">[[</span><span class="st">'2005'</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    weight     <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Here we have chosen equal weights for the two years.</p>
</div>
<div class="section level3">
<h3 id="the-post-processing-function">The Post-Processing Function<a class="anchor" aria-label="anchor" href="#the-post-processing-function"></a>
</h3>
<p>The observed data includes values of the total litter, which is
comprised of both leaf and stem litter. However, the model does not
calculate this quntity; instead, it returns separate values of leaf and
stem litter. To address this issue, we can provide a “post-processing
function.” This is an (optional) function that is applied to each
simulation result and can be used to add new columns. Here we define
such a function, which adds a new column for the total litter:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define the post-processing function</span></span>
<span><span class="va">post_process_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim_res</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Calculate the total litter as the sum of leaf and stem litter</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">within</a></span><span class="op">(</span><span class="va">sim_res</span>, <span class="op">{</span><span class="va">TotalLitter</span> <span class="op">=</span> <span class="va">LeafLitter</span> <span class="op">+</span> <span class="va">StemLitter</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-data-definitions">The Data Definitions<a class="anchor" aria-label="anchor" href="#the-data-definitions"></a>
</h3>
<p>The data sets above have columns whose names do not match the
corresponding model outputs. For example, the
<code>Leaf_Mg_per_ha</code> column of the observed data must be compared
to the <code>Leaf</code> column of the model output, since both
represent the leaf mass per unit ground area. To handle this mismatch,
we can provide a set of “data definitions” that specify which columns
should be compared:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define the data definition list, where the element names are columns in the</span></span>
<span><span class="co"># observed data tables, and the element values are the corresponding column</span></span>
<span><span class="co"># names in the model outputs</span></span>
<span><span class="va">data_definitions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span><span class="co"># Observed               Simulated</span></span>
<span>  CumLitter_Mg_per_ha <span class="op">=</span> <span class="st">'TotalLitter'</span>,</span>
<span>  Leaf_Mg_per_ha      <span class="op">=</span> <span class="st">'Leaf'</span>,</span>
<span>  Root_Mg_per_ha      <span class="op">=</span> <span class="st">'Root'</span>,</span>
<span>  Seed_Mg_per_ha      <span class="op">=</span> <span class="st">'Grain'</span>,</span>
<span>  Shell_Mg_per_ha     <span class="op">=</span> <span class="st">'Shell'</span>,</span>
<span>  Stem_Mg_per_ha      <span class="op">=</span> <span class="st">'Stem'</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-arguments-to-vary">The Arguments to Vary<a class="anchor" aria-label="anchor" href="#the-arguments-to-vary"></a>
</h3>
<p>Here we wish to vary several parameters related to carbon
partitioning for growth, senescence, maintenance respiration, and growth
respiration:</p>
<ul>
<li><p>For each growing tissue, there are two parameters (<span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span>) that influence the parbon
partitioning coefficients. Here we will vary these for the leaf, stem,
and shell (6 parameters in total).</p></li>
<li><p>For each senescing tissue, there are three parameters (<span class="math inline">\(\alpha_{sen}\)</span>, <span class="math inline">\(\beta_{sen}\)</span>, and <code>rate</code>) that
influence when senescence begins and the overall rate of scenescence.
Here we will vary these for the leaf and stem (6 parameters in
total).</p></li>
<li><p>For each growing tissue, there is one parameter
(<code>grc</code>) that influences the rate of carbon use for growth
respiration. Here we will vary these for the stem and root (2 parameters
in total).</p></li>
<li><p>For each tissue, there is one parameter (<code>mrc</code>) that
influences the rate of carbon use for maintenance respiration. Here we
will vary these for the leaf, stem, and root (3 parameters in
total).</p></li>
</ul>
<p>Together, this is 17 arguments to vary. Typically, an optimization
problem requires more time for each free parameter involved, so it is
helpful to vary the smallest possible set. One way to reduce the number
of free parameters is to treat some as being “dependent.” In other
words, to calculate the values of some parameters from the values of
others, so that only some of them are truly free or “independent.” Here
we will do this by fixing the value of <code>mrc_stem</code> to the
value of <code>mrc_leaf</code>. Thus, we can think of this is a single
maintenance respiration coefficient for the entire shoot; this reduces
the number of independent parameters by one (to 16).</p>
<p>The independent arguments must be specified as a list of named
numeric elements, where the name is the argument name and the value is
an initial guess for that argument. Here we will use the default
Soybean-BioCro values as our initial guesses:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define a list of independent arguments and their initial values</span></span>
<span><span class="va">independent_arg_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="co"># Partitioning for leaf, stem, and shell</span></span>
<span>  <span class="st">'alphaLeaf'</span>,</span>
<span>  <span class="st">'betaLeaf'</span>,</span>
<span>  <span class="st">'alphaStem'</span>,</span>
<span>  <span class="st">'betaStem'</span>,</span>
<span>  <span class="st">'alphaShell'</span>,</span>
<span>  <span class="st">'betaShell'</span>,</span>
<span></span>
<span>  <span class="co"># Senescence for leaf and stem</span></span>
<span>  <span class="st">'alphaSeneLeaf'</span>,</span>
<span>  <span class="st">'betaSeneLeaf'</span>,</span>
<span>  <span class="st">'rateSeneLeaf'</span>,</span>
<span>  <span class="st">'alphaSeneStem'</span>,</span>
<span>  <span class="st">'betaSeneStem'</span>,</span>
<span>  <span class="st">'rateSeneStem'</span>,</span>
<span></span>
<span>  <span class="co"># Growth respiration for stem and root</span></span>
<span>  <span class="st">'grc_stem'</span>,</span>
<span>  <span class="st">'grc_root'</span>,</span>
<span></span>
<span>  <span class="co"># Maintenance respiration for leaf and root</span></span>
<span>  <span class="st">'mrc_leaf'</span>,</span>
<span>  <span class="st">'mrc_root'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">independent_args</span> <span class="op">&lt;-</span> <span class="va">soybean</span><span class="op">$</span><span class="va">parameters</span><span class="op">[</span><span class="va">independent_arg_names</span><span class="op">]</span></span></code></pre></div>
<p>The dependent arguments must be specified as a function that takes a
list of independent arguments as its input, and returns a list of
dependent arguments as its output:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define a function that sets `mrc_stem` to the value of `mrc_leaf`</span></span>
<span><span class="va">dependent_arg_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ind_args</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mrc_stem <span class="op">=</span> <span class="va">ind_args</span><span class="op">[[</span><span class="st">'mrc_leaf'</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-quantity-weights">The Quantity Weights<a class="anchor" aria-label="anchor" href="#the-quantity-weights"></a>
</h3>
<p>When determining the error metric value, we wish to assign different
weights to each type of observed value. This can be handled via the
<code>quantity_weights</code>, which must be a list of named numeric
elements, where the name of each element is an output from the
simulation, and its value is the weight.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Specify the quantity weights; there is no systematic way to determine these,</span></span>
<span><span class="co"># but the following weights have worked well in the past for Soybean-BioCro</span></span>
<span><span class="va">quantity_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  Grain       <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>  Leaf        <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>  Root        <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  Shell       <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  Stem        <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>  TotalLitter <span class="op">=</span> <span class="fl">0.1</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-extra-penalty-function">The Extra Penalty Function<a class="anchor" aria-label="anchor" href="#the-extra-penalty-function"></a>
</h3>
<p>Sometimes an optimizer may choose parameter values that produce close
agreement with the observed data but are nevertheless unreasonable from
a biological perspective.</p>
<p>To prevent these unreasonable parameters from being chosen, “extra
penalties” can be added to the error metric. These penalties can be
specified using an <code>extra_penalty_function</code>, which must take
the result from a BioCro simulation as its input and return a numeric
error penalty value, which generally should be zero (when no issues are
found) or a large positive number (if an issue has been found).</p>
<p>For Soybean-BioCro parameterization, three common issues are
that:</p>
<ol style="list-style-type: decimal">
<li><p>Carbon is never partitioned to one or more key tissues.</p></li>
<li><p>Carbon partitioning to the stem and leaf starts at different
times.</p></li>
<li><p>Carbon partitioning to the leaves begins too early or too
late.</p></li>
</ol>
<p>The function below will return a large value when any of these
situations occurs, and will otherwise return a value of zero.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define an extra penalty function</span></span>
<span><span class="va">extra_penalty_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim_res</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Set the penalty value</span></span>
<span>  <span class="va">PENALTY</span> <span class="op">&lt;-</span> <span class="fl">9999</span></span>
<span></span>
<span>  <span class="co"># Get the first times when each partitioning coefficient becomes non-zero</span></span>
<span>  <span class="va">k_thresh</span> <span class="op">&lt;-</span> <span class="fl">0.01</span> <span class="co"># Threshold k value to decide when growth has started</span></span>
<span>  <span class="va">hpd</span>      <span class="op">&lt;-</span> <span class="fl">24.0</span> <span class="co"># Hours per day</span></span>
<span></span>
<span>  <span class="va">time</span> <span class="op">&lt;-</span> <span class="va">sim_res</span><span class="op">[[</span><span class="st">'time'</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">time_grain</span> <span class="op">&lt;-</span> <span class="va">time</span><span class="op">[</span><span class="va">sim_res</span><span class="op">[[</span><span class="st">'kGrain'</span><span class="op">]</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">k_thresh</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">time_leaf</span>  <span class="op">&lt;-</span> <span class="va">time</span><span class="op">[</span><span class="va">sim_res</span><span class="op">[[</span><span class="st">'kLeaf'</span><span class="op">]</span><span class="op">]</span>  <span class="op">&gt;</span> <span class="va">k_thresh</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">time_shell</span> <span class="op">&lt;-</span> <span class="va">time</span><span class="op">[</span><span class="va">sim_res</span><span class="op">[[</span><span class="st">'kShell'</span><span class="op">]</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">k_thresh</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">time_stem</span>  <span class="op">&lt;-</span> <span class="va">time</span><span class="op">[</span><span class="va">sim_res</span><span class="op">[[</span><span class="st">'kStem'</span><span class="op">]</span><span class="op">]</span>  <span class="op">&gt;</span> <span class="va">k_thresh</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Return a penalty if necessary</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">time_grain</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">time_leaf</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">time_shell</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">time_stem</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># One or more tissues is not growing</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">PENALTY</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">time_leaf</span> <span class="op">-</span> <span class="va">time_stem</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">5</span> <span class="op">*</span> <span class="va">hpd</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># The starts of leaf and stem growth are more than 5 days apart</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">PENALTY</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">time_leaf</span> <span class="op">-</span> <span class="va">time</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">20</span> <span class="op">*</span> <span class="va">hpd</span> <span class="op">|</span> <span class="va">time_leaf</span> <span class="op">-</span> <span class="va">time</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">10</span> <span class="op">*</span> <span class="va">hpd</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># The start of leaf growth is too late (more than 20 days after sowing) or</span></span>
<span>    <span class="co"># too early (fewer than 10 days after sowing)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">PENALTY</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># No problems were detected</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fl">0.0</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="the-objective-function">The Objective Function<a class="anchor" aria-label="anchor" href="#the-objective-function"></a>
</h3>
<p>Now we are just about ready to build the objective function. There
are a few more details to discuss:</p>
<ul>
<li><p>Soybean-BioCro has always used the <code>'mean_max'</code> method
for determining normalization factors; see Equations 14-16 of <span class="citation">Matthews et al. (<a href="#ref-matthews_soybean_biocro_2021">2021</a>)</span> for more
details.</p></li>
<li><p>Soybean-BioCro has always used the <code>'logarithm'</code>
method for determining weights from standard deviations with <span class="math inline">\(\epsilon = 10^{-5}\)</span>; see Equation 17 of
<span class="citation">Matthews et al. (<a href="#ref-matthews_soybean_biocro_2021">2021</a>)</span> for more
details.</p></li>
<li><p>Soybean-BioCro has not used any regularization.</p></li>
</ul>
<p>With this, it is possible to build the function. Note that some
useful information is printed out when the function is created, such as
the full list of observed values and their corresponding weights.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create the objective function</span></span>
<span><span class="va">obj_fun</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/objective_function.html">objective_function</a></span><span class="op">(</span></span>
<span>  <span class="va">base_model_definition</span>,</span>
<span>  <span class="va">data_driver_pairs</span>,</span>
<span>  <span class="va">independent_args</span>,</span>
<span>  <span class="va">quantity_weights</span>,</span>
<span>  data_definitions       <span class="op">=</span> <span class="va">data_definitions</span>,</span>
<span>  normalization_method   <span class="op">=</span> <span class="st">'mean_max'</span>,</span>
<span>  stdev_weight_method    <span class="op">=</span> <span class="st">'logarithm'</span>,</span>
<span>  stdev_weight_param     <span class="op">=</span> <span class="fl">1e-5</span>,</span>
<span>  regularization_method  <span class="op">=</span> <span class="st">'none'</span>,</span>
<span>  dependent_arg_function <span class="op">=</span> <span class="va">dependent_arg_function</span>,</span>
<span>  post_process_function  <span class="op">=</span> <span class="va">post_process_function</span>,</span>
<span>  extra_penalty_function <span class="op">=</span> <span class="va">extra_penalty_function</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; The independent arguments and their initial values:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; List of 16</span></span>
<span><span class="co">#&gt;  $ alphaLeaf    : num 23.9</span></span>
<span><span class="co">#&gt;  $ betaLeaf     : num -18.1</span></span>
<span><span class="co">#&gt;  $ alphaStem    : num 24.8</span></span>
<span><span class="co">#&gt;  $ betaStem     : num -18.5</span></span>
<span><span class="co">#&gt;  $ alphaShell   : num 13.6</span></span>
<span><span class="co">#&gt;  $ betaShell    : num -9.98</span></span>
<span><span class="co">#&gt;  $ alphaSeneLeaf: num 48.3</span></span>
<span><span class="co">#&gt;  $ betaSeneLeaf : num -29.5</span></span>
<span><span class="co">#&gt;  $ rateSeneLeaf : num 0.0122</span></span>
<span><span class="co">#&gt;  $ alphaSeneStem: num 4.19</span></span>
<span><span class="co">#&gt;  $ betaSeneStem : num -3.31</span></span>
<span><span class="co">#&gt;  $ rateSeneStem : num 0.000117</span></span>
<span><span class="co">#&gt;  $ grc_stem     : num 0.0283</span></span>
<span><span class="co">#&gt;  $ grc_root     : num 0.0027</span></span>
<span><span class="co">#&gt;  $ mrc_leaf     : num 0.000488</span></span>
<span><span class="co">#&gt;  $ mrc_root     : num 1e-05</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; The dependent arguments and their initial values:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; List of 1</span></span>
<span><span class="co">#&gt;  $ mrc_stem: num 0.000488</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; The full data definitions:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; List of 6</span></span>
<span><span class="co">#&gt;  $ Leaf_Mg_per_ha     : chr "Leaf"</span></span>
<span><span class="co">#&gt;  $ Stem_Mg_per_ha     : chr "Stem"</span></span>
<span><span class="co">#&gt;  $ Seed_Mg_per_ha     : chr "Grain"</span></span>
<span><span class="co">#&gt;  $ CumLitter_Mg_per_ha: chr "TotalLitter"</span></span>
<span><span class="co">#&gt;  $ Shell_Mg_per_ha    : chr "Shell"</span></span>
<span><span class="co">#&gt;  $ Root_Mg_per_ha     : chr "Root"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; The user-supplied data in long form:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $ambient_2002</span></span>
<span><span class="co">#&gt;    time quantity_name quantity_value quantity_stdev time_index expected_npts</span></span>
<span><span class="co">#&gt; 1  4272          Leaf   0.1802843394   0.0408155501        649          3288</span></span>
<span><span class="co">#&gt; 2  4512          Leaf   0.5544619422   0.1638632739        889          3288</span></span>
<span><span class="co">#&gt; 3  4848          Leaf   1.3265529308   0.1337744335       1225          3288</span></span>
<span><span class="co">#&gt; 4  5184          Leaf   1.6979440069   0.2283266576       1561          3288</span></span>
<span><span class="co">#&gt; 5  5520          Leaf   1.8077427820   0.2024754215       1897          3288</span></span>
<span><span class="co">#&gt; 6  5880          Leaf   1.5788136482   0.0754751654       2257          3288</span></span>
<span><span class="co">#&gt; 7  6192          Leaf   0.9475377733   0.3445500325       2569          3288</span></span>
<span><span class="co">#&gt; 8  6888          Leaf   0.0000000000   0.0000000000       3265          3288</span></span>
<span><span class="co">#&gt; 9  4272          Stem   0.0852449694   0.0170797372        649          3288</span></span>
<span><span class="co">#&gt; 10 4512          Stem   0.4188538932   0.1384490248        889          3288</span></span>
<span><span class="co">#&gt; 11 4848          Stem   1.7110673664   0.1837107594       1225          3288</span></span>
<span><span class="co">#&gt; 12 5184          Stem   2.8928258965   0.4487440652       1561          3288</span></span>
<span><span class="co">#&gt; 13 5520          Stem   3.6859142604   0.4534474707       1897          3288</span></span>
<span><span class="co">#&gt; 14 5880          Stem   3.7452607171   0.2753213561       2257          3288</span></span>
<span><span class="co">#&gt; 15 6192          Stem   3.6184015745   0.1510453777       2569          3288</span></span>
<span><span class="co">#&gt; 16 6888          Stem   2.3057012247   0.1483892609       3265          3288</span></span>
<span><span class="co">#&gt; 17 4272         Grain   0.0000000000   0.0000000000        649          3288</span></span>
<span><span class="co">#&gt; 18 4512         Grain   0.0000000000   0.0000000000        889          3288</span></span>
<span><span class="co">#&gt; 19 4848         Grain   0.0000000000   0.0000000000       1225          3288</span></span>
<span><span class="co">#&gt; 20 5184         Grain   0.0000000000   0.0000000000       1561          3288</span></span>
<span><span class="co">#&gt; 21 5520         Grain   0.0000000000   0.0000000000       1897          3288</span></span>
<span><span class="co">#&gt; 22 5880         Grain   2.4803149604   0.3660583625       2257          3288</span></span>
<span><span class="co">#&gt; 23 6192         Grain   4.8468941378   0.5144215602       2569          3288</span></span>
<span><span class="co">#&gt; 24 6888         Grain   5.4133858263   0.1152608235       3265          3288</span></span>
<span><span class="co">#&gt; 25 4272   TotalLitter   0.0000000000   0.0000000000        649          3288</span></span>
<span><span class="co">#&gt; 26 4512   TotalLitter   0.0000000000   0.0000000000        889          3288</span></span>
<span><span class="co">#&gt; 27 4848   TotalLitter   0.0000000000   0.0000000000       1225          3288</span></span>
<span><span class="co">#&gt; 28 5184   TotalLitter   0.0000000000   0.0000000000       1561          3288</span></span>
<span><span class="co">#&gt; 29 5520   TotalLitter   0.3818897637   0.0456182275       1897          3288</span></span>
<span><span class="co">#&gt; 30 5880   TotalLitter   0.6633127734   0.0676627660       2257          3288</span></span>
<span><span class="co">#&gt; 31 6192   TotalLitter   0.9786377952   0.0320523860       2569          3288</span></span>
<span><span class="co">#&gt; 32 6888   TotalLitter   2.5831766621   0.2678295161       3265          3288</span></span>
<span><span class="co">#&gt; 33 4272         Shell   0.0000000000   0.0000000000        649          3288</span></span>
<span><span class="co">#&gt; 34 4512         Shell   0.0000000000   0.0000000000        889          3288</span></span>
<span><span class="co">#&gt; 35 4848         Shell   0.0003171479   0.0005493162       1225          3288</span></span>
<span><span class="co">#&gt; 36 5184         Shell   0.0793963255   0.0309899985       1561          3288</span></span>
<span><span class="co">#&gt; 37 5520         Shell   1.5545713035   0.2184025435       1897          3288</span></span>
<span><span class="co">#&gt; 38 5880         Shell   1.4956986001   0.6804094230       2257          3288</span></span>
<span><span class="co">#&gt; 39 6192         Shell   1.6977565178   0.9040650516       2569          3288</span></span>
<span><span class="co">#&gt; 40 6888         Shell   1.5955818021   0.1827578015       3265          3288</span></span>
<span><span class="co">#&gt; 45 5520          Root   1.1981988188   0.3678694412       1897          3288</span></span>
<span><span class="co">#&gt;          norm      w_var</span></span>
<span><span class="co">#&gt; 1   52.286943  3.1984472</span></span>
<span><span class="co">#&gt; 2   52.286943  1.8086619</span></span>
<span><span class="co">#&gt; 3   52.286943  2.0115255</span></span>
<span><span class="co">#&gt; 4   52.286943  1.4769342</span></span>
<span><span class="co">#&gt; 5   52.286943  1.5970874</span></span>
<span><span class="co">#&gt; 6   52.286943  2.5838191</span></span>
<span><span class="co">#&gt; 7   52.286943  1.0654869</span></span>
<span><span class="co">#&gt; 8   52.286943 11.5129255</span></span>
<span><span class="co">#&gt; 9  224.431645  4.0692772</span></span>
<span><span class="co">#&gt; 10 224.431645  1.9771808</span></span>
<span><span class="co">#&gt; 11 224.431645  1.6943383</span></span>
<span><span class="co">#&gt; 12 224.431645  0.8012803</span></span>
<span><span class="co">#&gt; 13 224.431645  0.7908538</span></span>
<span><span class="co">#&gt; 14 224.431645  1.2897800</span></span>
<span><span class="co">#&gt; 15 224.431645  1.8901088</span></span>
<span><span class="co">#&gt; 16 224.431645  1.9078489</span></span>
<span><span class="co">#&gt; 17 468.875938 11.5129255</span></span>
<span><span class="co">#&gt; 18 468.875938 11.5129255</span></span>
<span><span class="co">#&gt; 19 468.875938 11.5129255</span></span>
<span><span class="co">#&gt; 20 468.875938 11.5129255</span></span>
<span><span class="co">#&gt; 21 468.875938 11.5129255</span></span>
<span><span class="co">#&gt; 22 468.875938  1.0049352</span></span>
<span><span class="co">#&gt; 23 468.875938  0.6646928</span></span>
<span><span class="co">#&gt; 24 468.875938  2.1604709</span></span>
<span><span class="co">#&gt; 25 106.764827 11.5129255</span></span>
<span><span class="co">#&gt; 26 106.764827 11.5129255</span></span>
<span><span class="co">#&gt; 27 106.764827 11.5129255</span></span>
<span><span class="co">#&gt; 28 106.764827 11.5129255</span></span>
<span><span class="co">#&gt; 29 106.764827  3.0872287</span></span>
<span><span class="co">#&gt; 30 106.764827  2.6930715</span></span>
<span><span class="co">#&gt; 31 106.764827  3.4400717</span></span>
<span><span class="co">#&gt; 32 106.764827  1.3173673</span></span>
<span><span class="co">#&gt; 33  46.118035 11.5129255</span></span>
<span><span class="co">#&gt; 34  46.118035 11.5129255</span></span>
<span><span class="co">#&gt; 35  46.118035  7.4887956</span></span>
<span><span class="co">#&gt; 36  46.118035  3.4737681</span></span>
<span><span class="co">#&gt; 37  46.118035  1.5213696</span></span>
<span><span class="co">#&gt; 38  46.118035  0.3850459</span></span>
<span><span class="co">#&gt; 39  46.118035  0.1008429</span></span>
<span><span class="co">#&gt; 40  46.118035  1.6995388</span></span>
<span><span class="co">#&gt; 45   2.871361  1.0000000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $ambient_2005</span></span>
<span><span class="co">#&gt;    time quantity_name quantity_value quantity_stdev time_index expected_npts</span></span>
<span><span class="co">#&gt; 1  4104          Leaf     0.22227188     0.03289659        577          2952</span></span>
<span><span class="co">#&gt; 2  4440          Leaf     0.84603750     0.14679830        913          2952</span></span>
<span><span class="co">#&gt; 3  4776          Leaf     1.18446563     0.33807429       1249          2952</span></span>
<span><span class="co">#&gt; 4  5112          Leaf     2.21805938     0.15217591       1585          2952</span></span>
<span><span class="co">#&gt; 5  5448          Leaf     2.14744687     0.11907759       1921          2952</span></span>
<span><span class="co">#&gt; 6  5784          Leaf     1.51948125     0.51280870       2257          2952</span></span>
<span><span class="co">#&gt; 7  6120          Leaf     0.06575625     0.06168624       2593          2952</span></span>
<span><span class="co">#&gt; 8  6456          Leaf     0.00000000     0.00000000       2929          2952</span></span>
<span><span class="co">#&gt; 9  4104          Stem     0.18880312     0.01431814        577          2952</span></span>
<span><span class="co">#&gt; 10 4440          Stem     0.85220625     0.19883006        913          2952</span></span>
<span><span class="co">#&gt; 11 4776          Stem     1.61896875     0.60528625       1249          2952</span></span>
<span><span class="co">#&gt; 12 5112          Stem     4.04361563     0.55987405       1585          2952</span></span>
<span><span class="co">#&gt; 13 5448          Stem     4.47772500     0.30674464       1921          2952</span></span>
<span><span class="co">#&gt; 14 5784          Stem     3.89208750     0.37910849       2257          2952</span></span>
<span><span class="co">#&gt; 15 6120          Stem     2.89905000     0.22082398       2593          2952</span></span>
<span><span class="co">#&gt; 16 6456          Stem     2.17560000     0.24325473       2929          2952</span></span>
<span><span class="co">#&gt; 17 4104         Grain     0.00000000     0.00000000        577          2952</span></span>
<span><span class="co">#&gt; 18 4440         Grain     0.00000000     0.00000000        913          2952</span></span>
<span><span class="co">#&gt; 19 4776         Grain     0.00000000     0.00000000       1249          2952</span></span>
<span><span class="co">#&gt; 20 5112         Grain     0.00000000     0.00000000       1585          2952</span></span>
<span><span class="co">#&gt; 21 5448         Grain     0.00000000     0.00000000       1921          2952</span></span>
<span><span class="co">#&gt; 22 5784         Grain     3.02249063     0.34171478       2257          2952</span></span>
<span><span class="co">#&gt; 23 6120         Grain     3.99820312     0.39895675       2593          2952</span></span>
<span><span class="co">#&gt; 24 6456         Grain     4.96564688     0.50722409       2929          2952</span></span>
<span><span class="co">#&gt; 25 4104   TotalLitter     0.00000000     0.00000000        577          2952</span></span>
<span><span class="co">#&gt; 26 4440   TotalLitter     0.00000000     0.00000000        913          2952</span></span>
<span><span class="co">#&gt; 27 4776   TotalLitter     0.00000000     0.00000000       1249          2952</span></span>
<span><span class="co">#&gt; 28 5112   TotalLitter     0.06654375     0.06370846       1585          2952</span></span>
<span><span class="co">#&gt; 29 5448   TotalLitter     0.18230625     0.05624687       1921          2952</span></span>
<span><span class="co">#&gt; 30 5784   TotalLitter     0.33593438     0.07334289       2257          2952</span></span>
<span><span class="co">#&gt; 31 6120   TotalLitter     0.86697187     0.21417663       2593          2952</span></span>
<span><span class="co">#&gt; 32 6456   TotalLitter     1.14843750     0.24626746       2929          2952</span></span>
<span><span class="co">#&gt; 33 4104         Shell     0.00000000     0.00000000        577          2952</span></span>
<span><span class="co">#&gt; 34 4440         Shell     0.00000000     0.00000000        913          2952</span></span>
<span><span class="co">#&gt; 35 4776         Shell     0.00000000     0.00000000       1249          2952</span></span>
<span><span class="co">#&gt; 36 5112         Shell     0.29925000     0.16427520       1585          2952</span></span>
<span><span class="co">#&gt; 37 5448         Shell     2.30455312     0.43414807       1921          2952</span></span>
<span><span class="co">#&gt; 38 5784         Shell     2.51028750     0.68049551       2257          2952</span></span>
<span><span class="co">#&gt; 39 6120         Shell     1.37287500     0.65544843       2593          2952</span></span>
<span><span class="co">#&gt; 40 6456         Shell     1.40660625     0.81122149       2929          2952</span></span>
<span><span class="co">#&gt; 45 5448          Root     1.51805325     0.36786944       1921          2952</span></span>
<span><span class="co">#&gt;          norm      w_var</span></span>
<span><span class="co">#&gt; 1   78.716598  3.4140824</span></span>
<span><span class="co">#&gt; 2   78.716598  1.9186276</span></span>
<span><span class="co">#&gt; 3   78.716598  1.0844600</span></span>
<span><span class="co">#&gt; 4   78.716598  1.8826524</span></span>
<span><span class="co">#&gt; 5   78.716598  2.1278960</span></span>
<span><span class="co">#&gt; 6   78.716598  0.6678329</span></span>
<span><span class="co">#&gt; 7   78.716598  2.7855322</span></span>
<span><span class="co">#&gt; 8   78.716598 11.5129255</span></span>
<span><span class="co">#&gt; 9  320.800339  4.2455301</span></span>
<span><span class="co">#&gt; 10 320.800339  1.6152545</span></span>
<span><span class="co">#&gt; 11 320.800339  0.5020373</span></span>
<span><span class="co">#&gt; 12 320.800339  0.5800256</span></span>
<span><span class="co">#&gt; 13 320.800339  1.1817071</span></span>
<span><span class="co">#&gt; 14 320.800339  0.9699065</span></span>
<span><span class="co">#&gt; 15 320.800339  1.5103441</span></span>
<span><span class="co">#&gt; 16 320.800339  1.4136050</span></span>
<span><span class="co">#&gt; 17 394.522382 11.5129255</span></span>
<span><span class="co">#&gt; 18 394.522382 11.5129255</span></span>
<span><span class="co">#&gt; 19 394.522382 11.5129255</span></span>
<span><span class="co">#&gt; 20 394.522382 11.5129255</span></span>
<span><span class="co">#&gt; 21 394.522382 11.5129255</span></span>
<span><span class="co">#&gt; 22 394.522382  1.0737496</span></span>
<span><span class="co">#&gt; 23 394.522382  0.9188772</span></span>
<span><span class="co">#&gt; 24 394.522382  0.6787827</span></span>
<span><span class="co">#&gt; 25  21.102539 11.5129255</span></span>
<span><span class="co">#&gt; 26  21.102539 11.5129255</span></span>
<span><span class="co">#&gt; 27  21.102539 11.5129255</span></span>
<span><span class="co">#&gt; 28  21.102539  2.7532810</span></span>
<span><span class="co">#&gt; 29  21.102539  2.8778272</span></span>
<span><span class="co">#&gt; 30  21.102539  2.6124734</span></span>
<span><span class="co">#&gt; 31  21.102539  1.5409076</span></span>
<span><span class="co">#&gt; 32  21.102539  1.4012965</span></span>
<span><span class="co">#&gt; 33 100.824693 11.5129255</span></span>
<span><span class="co">#&gt; 34 100.824693 11.5129255</span></span>
<span><span class="co">#&gt; 35 100.824693 11.5129255</span></span>
<span><span class="co">#&gt; 36 100.824693  1.8061514</span></span>
<span><span class="co">#&gt; 37 100.824693  0.8343466</span></span>
<span><span class="co">#&gt; 38 100.824693  0.3849194</span></span>
<span><span class="co">#&gt; 39 100.824693  0.4224204</span></span>
<span><span class="co">#&gt; 40 100.824693  0.2092018</span></span>
<span><span class="co">#&gt; 45   4.608971  1.0000000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; The user-supplied quantity weights:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; List of 6</span></span>
<span><span class="co">#&gt;  $ Grain      : num [1:2] 1 1</span></span>
<span><span class="co">#&gt;  $ Leaf       : num [1:2] 1 1</span></span>
<span><span class="co">#&gt;  $ Root       : num [1:2] 0.1 0.1</span></span>
<span><span class="co">#&gt;  $ Shell      : num [1:2] 0.5 0.5</span></span>
<span><span class="co">#&gt;  $ Stem       : num [1:2] 1 1</span></span>
<span><span class="co">#&gt;  $ TotalLitter: num [1:2] 0.1 0.1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; The user-supplied data-driver pair weights:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; List of 2</span></span>
<span><span class="co">#&gt;  $ ambient_2002: num 1</span></span>
<span><span class="co">#&gt;  $ ambient_2005: num 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; The initial error metric terms:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; List of 2</span></span>
<span><span class="co">#&gt;  $ terms_from_data_driver_pairs:List of 2</span></span>
<span><span class="co">#&gt;   ..$ ambient_2002:List of 2</span></span>
<span><span class="co">#&gt;   .. ..$ least_squares_terms:List of 6</span></span>
<span><span class="co">#&gt;   .. .. ..$ Grain      : num 0.00371</span></span>
<span><span class="co">#&gt;   .. .. ..$ Leaf       : num 0.0214</span></span>
<span><span class="co">#&gt;   .. .. ..$ Root       : num 0.00353</span></span>
<span><span class="co">#&gt;   .. .. ..$ Shell      : num 0.0115</span></span>
<span><span class="co">#&gt;   .. .. ..$ Stem       : num 0.0119</span></span>
<span><span class="co">#&gt;   .. .. ..$ TotalLitter: num 0.00264</span></span>
<span><span class="co">#&gt;   .. ..$ extra_penalty      : num 0</span></span>
<span><span class="co">#&gt;   ..$ ambient_2005:List of 2</span></span>
<span><span class="co">#&gt;   .. ..$ least_squares_terms:List of 6</span></span>
<span><span class="co">#&gt;   .. .. ..$ Grain      : num 0.00744</span></span>
<span><span class="co">#&gt;   .. .. ..$ Leaf       : num 0.00742</span></span>
<span><span class="co">#&gt;   .. .. ..$ Root       : num 0.0053</span></span>
<span><span class="co">#&gt;   .. .. ..$ Shell      : num 0.0118</span></span>
<span><span class="co">#&gt;   .. .. ..$ Stem       : num 0.00345</span></span>
<span><span class="co">#&gt;   .. .. ..$ TotalLitter: num 0.000304</span></span>
<span><span class="co">#&gt;   .. ..$ extra_penalty      : num 0</span></span>
<span><span class="co">#&gt;  $ regularization_penalty      : num 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; The initial error metric value:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [1] 0.09029496</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="optimizing-the-parameter-values">Optimizing the Parameter Values<a class="anchor" aria-label="anchor" href="#optimizing-the-parameter-values"></a>
</h2>
<p>The objective function is designed to be passed to a minimization
algorithm, which will determine the argument values that produce the
best agreement between the model predictions and the observations.</p>
<p>Soybean-BioCro has already been parameterized, so there is already
good agreement between the model and the data. This can be seen by
examining the value of the error metric when using the default
Soybean-BioCro values:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Evaluate the error function with default Soybean-BioCro parameters</span></span>
<span><span class="va">default_error</span> <span class="op">&lt;-</span> <span class="fu">obj_fun</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">independent_args</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This evaluates to 0.090295. This is a low value for a Soybean-BioCro
parameterization, indicating that good agreement has already been
found.</p>
<p>Here, as an example, we will intentionally change each parameter
value by a small random amount, and then use an optimizer to improve the
parameter values; in an ideal world, the optimizer will eventually pick
parameter values close to the original Soybean-BioCro values.</p>
<p>There are many optimizers available in R. Base R includes the
<code>optim</code> function, and others are available from the
<code>dfoptim</code> and <code>DEoptim</code> packages. Here we will use
the <code>nmkb</code> optimizer from the <code>dfoptim</code> library,
which requires upper and lower bounds for each parameter and an initial
guess.</p>
<div class="section level3">
<h3 id="choosing-an-initial-guess">Choosing an Initial Guess<a class="anchor" aria-label="anchor" href="#choosing-an-initial-guess"></a>
</h3>
<p>As mentioned above, we will intentionally choose a “bad” initial
guess by tweaking each parameter value by a small random amount. Note
that we set a seed to ensure the same result is obtained every time this
is performed. Also note that the initial guess must be a numeric vector,
where the elements are ordered as they are in
<code>independent_args</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Set a seed</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make an initial guess by perturbing the default values by a small amount</span></span>
<span><span class="va">rel_size</span> <span class="op">&lt;-</span> <span class="fl">0.02</span></span>
<span></span>
<span><span class="va">initial_guess</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">independent_args</span><span class="op">)</span> <span class="op">*</span></span>
<span>  <span class="op">(</span><span class="fl">1.0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">independent_args</span><span class="op">)</span>, <span class="op">-</span><span class="va">rel_size</span>, <span class="va">rel_size</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Even though the changes to parameter values are small, there is still
a substantial change in the value of the error metric:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Evaluate the error function with default Soybean-BioCro parameters</span></span>
<span><span class="va">initial_error</span> <span class="op">&lt;-</span> <span class="fu">obj_fun</span><span class="op">(</span><span class="va">initial_guess</span><span class="op">)</span></span></code></pre></div>
<p>This evaluates to 0.1847518, which is about 51 percent larger than
with the default parameter values.</p>
</div>
<div class="section level3">
<h3 id="choosing-lower-and-upper-bounds">Choosing Lower and Upper Bounds<a class="anchor" aria-label="anchor" href="#choosing-lower-and-upper-bounds"></a>
</h3>
<p>There is not always a systematic approach to choosing lower and upper
bounds for parameter values, but the following bounds have worked well
for Soybean-BioCro in the past:</p>
<ul>
<li><p>The <span class="math inline">\(\alpha\)</span> parameters used
in partitioning and senescence calculations are confined to the interval
[0, 50].</p></li>
<li><p>The <span class="math inline">\(\beta\)</span> parameters used in
partitioning and senescence calculations are confined to the interval
[-50, 0].</p></li>
<li><p>The senescence rates have a lower bound of zero, but have
different upper bounds for each tissue.</p></li>
<li><p>The maintenance respiration coefficients are confined to the
interval [1e-6, 1e-2].</p></li>
<li><p>The growth respiration coefficients must be positive and
non-zero, but have different bounds for each tissue.</p></li>
</ul>
<p>There are many possible ways to specify the bounds in R, but
ultimately they must be expressed as numeric vectors, where the elements
are ordered as they are in <code>independent_args</code>. Here we use
the <code>bounds_table</code> function from
<code>BioCroValidation</code> to create a data frame where the lower and
upper bounds are stored as columns. Later, the columns can be passed to
the optimizer. The <code>bounds_table</code> function will also check
the initial guess to ensure it lies within the bounds; for more
information about this function, see its help page by typing
<code><a href="../reference/bounds_table.html">?bounds_table</a></code> from an R terminal.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Specify some bounds</span></span>
<span><span class="va">aul</span> <span class="op">&lt;-</span> <span class="fl">50</span>   <span class="co"># Upper limit for alpha parameters</span></span>
<span><span class="va">bll</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">50</span>  <span class="co"># Lower limit for beta parameters</span></span>
<span><span class="va">mll</span> <span class="op">&lt;-</span> <span class="fl">1e-6</span> <span class="co"># Lower limit for mrc parameters</span></span>
<span><span class="va">mul</span> <span class="op">&lt;-</span> <span class="fl">1e-2</span> <span class="co"># Upper limit for mrc parameters</span></span>
<span></span>
<span><span class="co"># Define a table with the bounds in the same order as `independent_args`</span></span>
<span><span class="va">bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bounds_table.html">bounds_table</a></span><span class="op">(</span></span>
<span>  <span class="va">independent_args</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    alphaLeaf     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,      <span class="va">aul</span><span class="op">)</span>,</span>
<span>    alphaStem     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,      <span class="va">aul</span><span class="op">)</span>,</span>
<span>    alphaShell    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,      <span class="va">aul</span><span class="op">)</span>,</span>
<span>    alphaSeneLeaf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,      <span class="va">aul</span><span class="op">)</span>,</span>
<span>    alphaSeneStem <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,      <span class="va">aul</span><span class="op">)</span>,</span>
<span>    betaLeaf      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bll</span>,    <span class="fl">0</span><span class="op">)</span>,</span>
<span>    betaStem      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bll</span>,    <span class="fl">0</span><span class="op">)</span>,</span>
<span>    betaShell     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bll</span>,    <span class="fl">0</span><span class="op">)</span>,</span>
<span>    betaSeneLeaf  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bll</span>,    <span class="fl">0</span><span class="op">)</span>,</span>
<span>    betaSeneStem  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bll</span>,    <span class="fl">0</span><span class="op">)</span>,</span>
<span>    rateSeneLeaf  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,      <span class="fl">0.0125</span><span class="op">)</span>,</span>
<span>    rateSeneStem  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,      <span class="fl">0.005</span><span class="op">)</span>,</span>
<span>    mrc_leaf      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mll</span>,    <span class="va">mul</span><span class="op">)</span>,</span>
<span>    mrc_root      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mll</span>,    <span class="va">mul</span><span class="op">)</span>,</span>
<span>    grc_stem      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8e-4</span>,   <span class="fl">0.08</span><span class="op">)</span>,</span>
<span>    grc_root      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.0025</span>, <span class="fl">0.075</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="va">initial_guess</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="running-the-optimizer">Running the Optimizer<a class="anchor" aria-label="anchor" href="#running-the-optimizer"></a>
</h3>
<p>Now we will use an optimizer to improve on the initial guess. As
mentioned above, we will use the <code>nmkb</code> optimizer from the
<code>dfoptim</code> package. This is a good choice when a decent
starting guess is known. If a broader search is necessary,
<code>DEoptim</code> from the <code>DEoptim</code> package may be more
appropriate, although it generally needs more time to run.</p>
<p>To make sure this example does not take too much time, we will use a
loose tolerance; a more realistic example would probably use
<code>1e-4</code> or <code>1e-5</code>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run the optimizer</span></span>
<span><span class="va">optim_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dfoptim/man/nmkb.html" class="external-link">nmkb</a></span><span class="op">(</span></span>
<span>  <span class="va">initial_guess</span>,</span>
<span>  <span class="va">obj_fun</span>,</span>
<span>  <span class="va">bounds</span><span class="op">[[</span><span class="st">'lower'</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="va">bounds</span><span class="op">[[</span><span class="st">'upper'</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    tol <span class="op">=</span> <span class="fl">1e-2</span>,</span>
<span>    restarts.max <span class="op">=</span> <span class="fl">10</span></span>
<span>  <span class="op">)</span>,</span>
<span>  debug_mode <span class="op">=</span> <span class="cn">FALSE</span> <span class="co"># Passed to obj_fun; set to TRUE to enable debug mode</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>When this document was generated, running the optimizer required the
following amount of time:</p>
<pre><code><span><span class="co">#&gt;    user  system elapsed </span></span>
<span><span class="co">#&gt;  82.471   0.298  82.778</span></span></code></pre>
<p>The total time was about 1.38 minutes. For a real parameterization
problem, it can be many times longer, and may even need days to run on a
personal laptop computer.</p>
<p>The optimizer also reports how many times the objective function was
called, among other details:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">optim_res</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 6</span></span>
<span><span class="co">#&gt;  $ par        : num [1:16] 23.9 -18.2 24.8 -18.4 13.5 ...</span></span>
<span><span class="co">#&gt;  $ value      : num 0.0921</span></span>
<span><span class="co">#&gt;  $ feval      : num 207</span></span>
<span><span class="co">#&gt;  $ restarts   : num 5</span></span>
<span><span class="co">#&gt;  $ convergence: num 0</span></span>
<span><span class="co">#&gt;  $ message    : chr "Successful convergence"</span></span></code></pre></div>
<p>The value of <code>feval</code> is 207, so on average, each call of
the objective function required approximately 0.4 seconds.</p>
</div>
<div class="section level3">
<h3 id="comparing-parameter-values">Comparing Parameter Values<a class="anchor" aria-label="anchor" href="#comparing-parameter-values"></a>
</h3>
<p>Let’s see whether the optimized parameters are closer to the default
parameters than the initial guess was.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create a table of the various independent argument values</span></span>
<span><span class="va">ind_arg_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  arg_name      <span class="op">=</span> <span class="va">independent_arg_names</span>,</span>
<span>  defaults      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">independent_args</span><span class="op">)</span>,</span>
<span>  initial_guess <span class="op">=</span> <span class="va">initial_guess</span>,</span>
<span>  optimized     <span class="op">=</span> <span class="va">optim_res</span><span class="op">[[</span><span class="st">'par'</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add differences</span></span>
<span><span class="va">ind_arg_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">within</a></span><span class="op">(</span><span class="va">ind_arg_table</span>, <span class="op">{</span></span>
<span>  <span class="va">initial_diff</span>   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">initial_guess</span> <span class="op">-</span> <span class="va">defaults</span><span class="op">)</span></span>
<span>  <span class="va">optimized_diff</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">optimized</span> <span class="op">-</span> <span class="va">defaults</span><span class="op">)</span></span>
<span>  <span class="va">improved</span>       <span class="op">=</span> <span class="va">optimized_diff</span> <span class="op">&lt;</span> <span class="va">initial_diff</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">ind_arg_table</span><span class="op">)</span></span>
<span><span class="co">#&gt;         arg_name     defaults initial_guess     optimized improved</span></span>
<span><span class="co">#&gt; 1      alphaLeaf  23.88950000  2.352036e+01  2.386565e+01     TRUE</span></span>
<span><span class="co">#&gt; 2       betaLeaf -18.08510000 -1.817357e+01 -1.817064e+01     TRUE</span></span>
<span><span class="co">#&gt; 3      alphaStem  24.82480000  2.493331e+01  2.479432e+01     TRUE</span></span>
<span><span class="co">#&gt; 4       betaStem -18.52140000 -1.861281e+01 -1.844565e+01     TRUE</span></span>
<span><span class="co">#&gt; 5     alphaShell  13.59550000  1.379177e+01  1.347693e+01     TRUE</span></span>
<span><span class="co">#&gt; 6      betaShell  -9.98090000 -1.003692e+01 -1.000498e+01     TRUE</span></span>
<span><span class="co">#&gt; 7  alphaSeneLeaf  48.32000000  4.737195e+01  4.986793e+01    FALSE</span></span>
<span><span class="co">#&gt; 8   betaSeneLeaf -29.53930000 -2.922329e+01 -3.023728e+01    FALSE</span></span>
<span><span class="co">#&gt; 9   rateSeneLeaf   0.01219800  1.227904e-02  1.244641e-02    FALSE</span></span>
<span><span class="co">#&gt; 10 alphaSeneStem   4.19370000  4.196091e+00  3.889660e+00    FALSE</span></span>
<span><span class="co">#&gt; 11  betaSeneStem  -3.31240000 -3.338050e+00 -3.387799e+00    FALSE</span></span>
<span><span class="co">#&gt; 12  rateSeneStem   0.00011700  1.172105e-04  1.274687e-04    FALSE</span></span>
<span><span class="co">#&gt; 13      grc_stem   0.02828000  2.803423e-02  2.844730e-02     TRUE</span></span>
<span><span class="co">#&gt; 14      grc_root   0.00270000  2.745731e-03  2.763255e-03    FALSE</span></span>
<span><span class="co">#&gt; 15      mrc_leaf   0.00048836  4.843030e-04  5.059738e-04    FALSE</span></span>
<span><span class="co">#&gt; 16      mrc_root   0.00001000  1.013492e-05  1.072817e-05    FALSE</span></span>
<span><span class="co">#&gt;    optimized_diff initial_diff</span></span>
<span><span class="co">#&gt; 1    2.385246e-02 3.691373e-01</span></span>
<span><span class="co">#&gt; 2    8.554244e-02 8.847188e-02</span></span>
<span><span class="co">#&gt; 3    3.048061e-02 1.085089e-01</span></span>
<span><span class="co">#&gt; 4    7.574948e-02 9.140640e-02</span></span>
<span><span class="co">#&gt; 5    1.185710e-01 1.962730e-01</span></span>
<span><span class="co">#&gt; 6    2.408361e-02 5.601704e-02</span></span>
<span><span class="co">#&gt; 7    1.547928e+00 9.480466e-01</span></span>
<span><span class="co">#&gt; 8    6.979834e-01 3.160108e-01</span></span>
<span><span class="co">#&gt; 9    2.484111e-04 8.103559e-05</span></span>
<span><span class="co">#&gt; 10   3.040402e-01 2.390600e-03</span></span>
<span><span class="co">#&gt; 11   7.539867e-02 2.565007e-02</span></span>
<span><span class="co">#&gt; 12   1.046873e-05 2.104822e-07</span></span>
<span><span class="co">#&gt; 13   1.673041e-04 2.457718e-04</span></span>
<span><span class="co">#&gt; 14   6.325510e-05 4.573082e-05</span></span>
<span><span class="co">#&gt; 15   1.761377e-05 4.056985e-06</span></span>
<span><span class="co">#&gt; 16   7.281688e-07 1.349183e-07</span></span></code></pre></div>
<p>In this table, when the <code>improved</code> column is
<code>TRUE</code>, this means that the optimized parameter value is
closer to the default value than the initial guess was; in other words,
it means that the optimizer truly improved on the initial guess. In this
example, 7 out of 16 parameter estimates were improved (44 percent).</p>
<p>We can also compare the error metric to its original value. As shown
above, it is now 0.0920539, which is only 1.9 percent larger than with
the default parameter values.</p>
<p>The optimized parameter values could likely be improved by using a
more stringent tolerance for the optimizer, but this would require more
time to run.</p>
</div>
<div class="section level3">
<h3 id="comparing-model-outputs">Comparing Model Outputs<a class="anchor" aria-label="anchor" href="#comparing-model-outputs"></a>
</h3>
<p>Another way to evaluate the results of the optimization is to compare
simulations using the default, perturbed, and re-optimized versions of
the model.</p>
<p>Following the re-parameterization, we now have new values of the
independent arguments, but this is not enough to actually run the new
version of the model. Thus, the next step is to form a new model
definition by updating the values of the default soybean model. This can
be accomplished using the <code>update_model</code> function from
<code>BioCroValidation</code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get model definition lists for the perturbed and re-parameterized versions of</span></span>
<span><span class="co"># the soybean model</span></span>
<span><span class="va">soybean_perturbed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_model.html">update_model</a></span><span class="op">(</span></span>
<span>  <span class="fu">BioCro</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/BioCro/man/soybean.html" class="external-link">soybean</a></span>,</span>
<span>  <span class="va">independent_args</span>,</span>
<span>  <span class="va">initial_guess</span>,</span>
<span>  dependent_arg_function <span class="op">=</span> <span class="va">dependent_arg_function</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">soybean_reparam</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_model.html">update_model</a></span><span class="op">(</span></span>
<span>  <span class="fu">BioCro</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/BioCro/man/soybean.html" class="external-link">soybean</a></span>,</span>
<span>  <span class="va">independent_args</span>,</span>
<span>  <span class="va">optim_res</span><span class="op">[[</span><span class="st">'par'</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  dependent_arg_function <span class="op">=</span> <span class="va">dependent_arg_function</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can check that the three models have different values of key
parameters, such as the “dependent” argument <code>mrc_stem</code>:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu">BioCro</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/BioCro/man/soybean.html" class="external-link">soybean</a></span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">mrc_stem</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.00048836</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">soybean_perturbed</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">mrc_stem</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.000484303</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">soybean_reparam</span><span class="op">$</span><span class="va">parameters</span><span class="op">$</span><span class="va">mrc_stem</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.0005059738</span></span></code></pre></div>
<p>Now we can run each version of the model for a single year and
visually compare their outputs:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Define a helper function that runs a single model for the year 2005</span></span>
<span><span class="va">run_2005</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model_definition</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">model_definition</span>, <span class="op">{</span><span class="fu"><a href="https://rdrr.io/pkg/BioCro/man/run_biocro.html" class="external-link">run_biocro</a></span><span class="op">(</span></span>
<span>    <span class="va">initial_values</span>,</span>
<span>    <span class="va">parameters</span>,</span>
<span>    <span class="va">soybean_weather</span><span class="op">[[</span><span class="st">'2005'</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    <span class="va">direct_modules</span>,</span>
<span>    <span class="va">differential_modules</span>,</span>
<span>    <span class="va">ode_solver</span></span>
<span>  <span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Run each model and combine the results</span></span>
<span><span class="va">full_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">within</a></span><span class="op">(</span><span class="fu">run_2005</span><span class="op">(</span><span class="fu">BioCro</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/BioCro/man/soybean.html" class="external-link">soybean</a></span><span class="op">)</span>,   <span class="op">{</span><span class="va">model</span> <span class="op">=</span> <span class="st">'Default Soybean-BioCro'</span><span class="op">}</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">within</a></span><span class="op">(</span><span class="fu">run_2005</span><span class="op">(</span><span class="va">soybean_perturbed</span><span class="op">)</span>, <span class="op">{</span><span class="va">model</span> <span class="op">=</span> <span class="st">'Perturbed Soybean-BioCro'</span><span class="op">}</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">within</a></span><span class="op">(</span><span class="fu">run_2005</span><span class="op">(</span><span class="va">soybean_reparam</span><span class="op">)</span>,   <span class="op">{</span><span class="va">model</span> <span class="op">=</span> <span class="st">'Re-parameterized Soybean-BioCro'</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the results</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>  <span class="va">Leaf</span> <span class="op">+</span> <span class="va">Stem</span> <span class="op">+</span> <span class="va">Root</span> <span class="op">+</span> <span class="va">Grain</span> <span class="op">~</span> <span class="va">fractional_doy</span>,</span>
<span>  group <span class="op">=</span> <span class="va">model</span>,</span>
<span>  data <span class="op">=</span> <span class="va">full_res</span>,</span>
<span>  type <span class="op">=</span> <span class="st">'l'</span>,</span>
<span>  auto.key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>space <span class="op">=</span> <span class="st">'top'</span><span class="op">)</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">'Day of year (2005)'</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">'Biomass (Mg / ha)'</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="parameterizing_soybean_biocro_files/figure-html/comparison_plots-1.png" width="720" style="display: block; margin: auto;"></p>
<p>Here we can see that while the simulated values for some tissues do
not differ much between the models, there are large differences in other
tissues; for these cases, the default and re-optimized versions are
similar and the perturbed version is much different.</p>
</div>
<div class="section level3">
<h3 id="saving-the-new-model-definition">Saving the New Model Definition<a class="anchor" aria-label="anchor" href="#saving-the-new-model-definition"></a>
</h3>
<p>A realistic parameterization takes a long time to complete, so it is
important to save the results for later use. One approach is to save the
model definition list using the <code>save</code> or
<code>saveRDS</code> functions from base R. However, these options
create binary files that are not human-readable, and they cannot be
easily tracked using <code>git</code>. As an alternative, the
<code>BioCroValidation</code> includes a function called
<code>write_model</code> that forms a string representing an R command
that can be called to re-create a model definition. This command string
can be written to a text file, making it easy to read and to track with
<code>git</code>.</p>
<p>Here we apply <code>write_model</code> to the re-optimized soybean
model:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Convert the re-parameterized soybean model to an R command string</span></span>
<span><span class="va">r_cmd_string</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">soybean_reparam</span>, <span class="fu"><a href="../reference/write_model.html">write_model</a></span><span class="op">(</span></span>
<span>  <span class="st">'soybean_reparam'</span>,</span>
<span>  <span class="va">direct_modules</span>,</span>
<span>  <span class="va">differential_modules</span>,</span>
<span>  <span class="va">initial_values</span>,</span>
<span>  <span class="va">parameters</span>,</span>
<span>  <span class="va">ode_solver</span></span>
<span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can view the resulting R command string:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="va">r_cmd_string</span><span class="op">)</span></span>
<span><span class="co">#&gt; soybean_reparam &lt;- list(</span></span>
<span><span class="co">#&gt;     direct_modules = list(</span></span>
<span><span class="co">#&gt;         "BioCro:format_time",</span></span>
<span><span class="co">#&gt;         "BioCro:stomata_water_stress_linear",</span></span>
<span><span class="co">#&gt;         "BioCro:sla_linear",</span></span>
<span><span class="co">#&gt;         "BioCro:parameter_calculator",</span></span>
<span><span class="co">#&gt;         "BioCro:soybean_development_rate_calculator",</span></span>
<span><span class="co">#&gt;         "BioCro:leaf_water_stress_exponential",</span></span>
<span><span class="co">#&gt;         "BioCro:partitioning_coefficient_logistic",</span></span>
<span><span class="co">#&gt;         "BioCro:soil_evaporation",</span></span>
<span><span class="co">#&gt;         "BioCro:solar_position_michalsky",</span></span>
<span><span class="co">#&gt;         "BioCro:shortwave_atmospheric_scattering",</span></span>
<span><span class="co">#&gt;         "BioCro:incident_shortwave_from_ground_par",</span></span>
<span><span class="co">#&gt;         "BioCro:height_from_lai",</span></span>
<span><span class="co">#&gt;         "BioCro:canopy_gbw_thornley",</span></span>
<span><span class="co">#&gt;         "BioCro:stefan_boltzmann_longwave",</span></span>
<span><span class="co">#&gt;         "BioCro:ten_layer_canopy_properties",</span></span>
<span><span class="co">#&gt;         "BioCro:ten_layer_c3_canopy",</span></span>
<span><span class="co">#&gt;         "BioCro:ten_layer_canopy_integrator",</span></span>
<span><span class="co">#&gt;         "BioCro:no_leaf_resp_neg_assim_partitioning_growth_calculator",</span></span>
<span><span class="co">#&gt;         "BioCro:senescence_coefficient_logistic",</span></span>
<span><span class="co">#&gt;         "BioCro:carbon_assimilation_to_biomass"</span></span>
<span><span class="co">#&gt;     ),</span></span>
<span><span class="co">#&gt;     differential_modules = list(</span></span>
<span><span class="co">#&gt;         "BioCro:senescence_logistic",</span></span>
<span><span class="co">#&gt;         "BioCro:maintenance_respiration",</span></span>
<span><span class="co">#&gt;         "BioCro:partitioning_growth",</span></span>
<span><span class="co">#&gt;         "BioCro:two_layer_soil_profile",</span></span>
<span><span class="co">#&gt;         "BioCro:development_index",</span></span>
<span><span class="co">#&gt;         "BioCro:thermal_time_linear"</span></span>
<span><span class="co">#&gt;     ),</span></span>
<span><span class="co">#&gt;     ode_solver = list(</span></span>
<span><span class="co">#&gt;         type = "boost_rkck54",</span></span>
<span><span class="co">#&gt;         output_step_size = 1.000000,</span></span>
<span><span class="co">#&gt;         adaptive_rel_error_tol = 1.000000e-04,</span></span>
<span><span class="co">#&gt;         adaptive_abs_error_tol = 1.000000e-04,</span></span>
<span><span class="co">#&gt;         adaptive_max_steps = 200</span></span>
<span><span class="co">#&gt;     ),</span></span>
<span><span class="co">#&gt;     initial_values = list(</span></span>
<span><span class="co">#&gt;         "Leaf" = 0.06312,</span></span>
<span><span class="co">#&gt;         "Stem" = 0.00789,</span></span>
<span><span class="co">#&gt;         "Root" = 0.00789,</span></span>
<span><span class="co">#&gt;         "Grain" = 1e-05,</span></span>
<span><span class="co">#&gt;         "Shell" = 1e-05,</span></span>
<span><span class="co">#&gt;         "LeafLitter" = 0,</span></span>
<span><span class="co">#&gt;         "RootLitter" = 0,</span></span>
<span><span class="co">#&gt;         "StemLitter" = 0,</span></span>
<span><span class="co">#&gt;         "soil_water_content" = 0.32,</span></span>
<span><span class="co">#&gt;         "cws1" = 0.32,</span></span>
<span><span class="co">#&gt;         "cws2" = 0.32,</span></span>
<span><span class="co">#&gt;         "DVI" = -1,</span></span>
<span><span class="co">#&gt;         "TTc" = 0,</span></span>
<span><span class="co">#&gt;         "Rhizome" = 1e-07,</span></span>
<span><span class="co">#&gt;         "RhizomeLitter" = 0</span></span>
<span><span class="co">#&gt;     ),</span></span>
<span><span class="co">#&gt;     parameters = list(</span></span>
<span><span class="co">#&gt;         "soil_air_entry" = -2.6,</span></span>
<span><span class="co">#&gt;         "soil_b_coefficient" = 5.2,</span></span>
<span><span class="co">#&gt;         "soil_bulk_density" = 1.35,</span></span>
<span><span class="co">#&gt;         "soil_clay_content" = 0.34,</span></span>
<span><span class="co">#&gt;         "soil_field_capacity" = 0.32,</span></span>
<span><span class="co">#&gt;         "soil_sand_content" = 0.32,</span></span>
<span><span class="co">#&gt;         "soil_saturated_conductivity" = 6.4e-05,</span></span>
<span><span class="co">#&gt;         "soil_saturation_capacity" = 0.52,</span></span>
<span><span class="co">#&gt;         "soil_silt_content" = 0.34,</span></span>
<span><span class="co">#&gt;         "soil_wilting_point" = 0.2,</span></span>
<span><span class="co">#&gt;         "iSp" = 3.5,</span></span>
<span><span class="co">#&gt;         "Sp_thermal_time_decay" = 0,</span></span>
<span><span class="co">#&gt;         "LeafN" = 2,</span></span>
<span><span class="co">#&gt;         "LeafN_0" = 2,</span></span>
<span><span class="co">#&gt;         "vmax_n_intercept" = 0,</span></span>
<span><span class="co">#&gt;         "vmax1" = 110,</span></span>
<span><span class="co">#&gt;         "alphab1" = 0,</span></span>
<span><span class="co">#&gt;         "alpha1" = 0,</span></span>
<span><span class="co">#&gt;         "maturity_group" = 3,</span></span>
<span><span class="co">#&gt;         "Tbase_emr" = 10,</span></span>
<span><span class="co">#&gt;         "TTemr_threshold" = 60,</span></span>
<span><span class="co">#&gt;         "Rmax_emrV0" = 0.199,</span></span>
<span><span class="co">#&gt;         "Tmin_emrV0" = 5,</span></span>
<span><span class="co">#&gt;         "Topt_emrV0" = 31.5,</span></span>
<span><span class="co">#&gt;         "Tmax_emrV0" = 45,</span></span>
<span><span class="co">#&gt;         "Tmin_R0R1" = 5,</span></span>
<span><span class="co">#&gt;         "Topt_R0R1" = 31.5,</span></span>
<span><span class="co">#&gt;         "Tmax_R0R1" = 45,</span></span>
<span><span class="co">#&gt;         "Tmin_R1R7" = 0,</span></span>
<span><span class="co">#&gt;         "Topt_R1R7" = 21.5,</span></span>
<span><span class="co">#&gt;         "Tmax_R1R7" = 38.7,</span></span>
<span><span class="co">#&gt;         "sowing_fractional_doy" = 0,</span></span>
<span><span class="co">#&gt;         "alphaLeaf" = 23.8656475358454,</span></span>
<span><span class="co">#&gt;         "alphaStem" = 24.7943193862222,</span></span>
<span><span class="co">#&gt;         "betaLeaf" = -18.1706424424747,</span></span>
<span><span class="co">#&gt;         "betaStem" = -18.4456505196764,</span></span>
<span><span class="co">#&gt;         "alphaRoot" = 36.967,</span></span>
<span><span class="co">#&gt;         "betaRoot" = -40.1915,</span></span>
<span><span class="co">#&gt;         "alphaShell" = 13.4769290411408,</span></span>
<span><span class="co">#&gt;         "betaShell" = -10.0049836091908,</span></span>
<span><span class="co">#&gt;         "kRhizome_emr" = 0,</span></span>
<span><span class="co">#&gt;         "rsec" = 0.2,</span></span>
<span><span class="co">#&gt;         "soil_clod_size" = 0.04,</span></span>
<span><span class="co">#&gt;         "soil_reflectance" = 0.2,</span></span>
<span><span class="co">#&gt;         "soil_transmission" = 0.01,</span></span>
<span><span class="co">#&gt;         "specific_heat_of_air" = 1010,</span></span>
<span><span class="co">#&gt;         "lat" = 40,</span></span>
<span><span class="co">#&gt;         "longitude" = -88,</span></span>
<span><span class="co">#&gt;         "atmospheric_pressure" = 101325,</span></span>
<span><span class="co">#&gt;         "atmospheric_transmittance" = 0.6,</span></span>
<span><span class="co">#&gt;         "atmospheric_scattering" = 0.3,</span></span>
<span><span class="co">#&gt;         "par_energy_fraction" = 0.5,</span></span>
<span><span class="co">#&gt;         "par_energy_content" = 0.219,</span></span>
<span><span class="co">#&gt;         "heightf" = 6,</span></span>
<span><span class="co">#&gt;         "min_gbw_canopy" = 0.005,</span></span>
<span><span class="co">#&gt;         "dry_biomass_per_carbon" = 30.026,</span></span>
<span><span class="co">#&gt;         "emissivity_sky" = 1,</span></span>
<span><span class="co">#&gt;         "chil" = 0.81,</span></span>
<span><span class="co">#&gt;         "k_diffuse" = 0.7,</span></span>
<span><span class="co">#&gt;         "kpLN" = 0,</span></span>
<span><span class="co">#&gt;         "leaf_reflectance_nir" = 0.42,</span></span>
<span><span class="co">#&gt;         "leaf_reflectance_par" = 0.1,</span></span>
<span><span class="co">#&gt;         "leaf_transmittance_nir" = 0.42,</span></span>
<span><span class="co">#&gt;         "leaf_transmittance_par" = 0.05,</span></span>
<span><span class="co">#&gt;         "lnfun" = 0,</span></span>
<span><span class="co">#&gt;         "Gstar_c" = 19.02,</span></span>
<span><span class="co">#&gt;         "Gstar_Ea" = 37830,</span></span>
<span><span class="co">#&gt;         "Jmax_c" = 17.57,</span></span>
<span><span class="co">#&gt;         "Jmax_Ea" = 43540,</span></span>
<span><span class="co">#&gt;         "Kc_c" = 38.05,</span></span>
<span><span class="co">#&gt;         "Kc_Ea" = 79430,</span></span>
<span><span class="co">#&gt;         "Ko_c" = 20.3,</span></span>
<span><span class="co">#&gt;         "Ko_Ea" = 36380,</span></span>
<span><span class="co">#&gt;         "phi_PSII_0" = 0.352,</span></span>
<span><span class="co">#&gt;         "phi_PSII_1" = 0.022,</span></span>
<span><span class="co">#&gt;         "phi_PSII_2" = -0.00034,</span></span>
<span><span class="co">#&gt;         "Rd_c" = 18.72,</span></span>
<span><span class="co">#&gt;         "Rd_Ea" = 46390,</span></span>
<span><span class="co">#&gt;         "theta_0" = 0.76,</span></span>
<span><span class="co">#&gt;         "theta_1" = 0.018,</span></span>
<span><span class="co">#&gt;         "theta_2" = -0.00037,</span></span>
<span><span class="co">#&gt;         "Tp_c" = 19.77399,</span></span>
<span><span class="co">#&gt;         "Tp_Ha" = 62990,</span></span>
<span><span class="co">#&gt;         "Tp_Hd" = 182140,</span></span>
<span><span class="co">#&gt;         "Tp_S" = 588,</span></span>
<span><span class="co">#&gt;         "Vcmax_c" = 26.35,</span></span>
<span><span class="co">#&gt;         "Vcmax_Ea" = 65330,</span></span>
<span><span class="co">#&gt;         "jmax" = 195,</span></span>
<span><span class="co">#&gt;         "jmax_mature" = 195,</span></span>
<span><span class="co">#&gt;         "sf_jmax" = 0.2,</span></span>
<span><span class="co">#&gt;         "electrons_per_carboxylation" = 4.5,</span></span>
<span><span class="co">#&gt;         "electrons_per_oxygenation" = 5.25,</span></span>
<span><span class="co">#&gt;         "tpu_rate_max" = 13,</span></span>
<span><span class="co">#&gt;         "Rd" = 1.28,</span></span>
<span><span class="co">#&gt;         "Catm" = 372.59,</span></span>
<span><span class="co">#&gt;         "O2" = 210,</span></span>
<span><span class="co">#&gt;         "b0" = 0.008,</span></span>
<span><span class="co">#&gt;         "b1" = 10.6,</span></span>
<span><span class="co">#&gt;         "Gs_min" = 0.001,</span></span>
<span><span class="co">#&gt;         "windspeed_height" = 5,</span></span>
<span><span class="co">#&gt;         "beta_PSII" = 0.5,</span></span>
<span><span class="co">#&gt;         "leafwidth" = 0.1,</span></span>
<span><span class="co">#&gt;         "growth_respiration_fraction" = 0,</span></span>
<span><span class="co">#&gt;         "grc_stem" = 0.0284473040567858,</span></span>
<span><span class="co">#&gt;         "grc_root" = 0.00276325510436536,</span></span>
<span><span class="co">#&gt;         "mrc_leaf" = 0.000505973771827042,</span></span>
<span><span class="co">#&gt;         "mrc_stem" = 0.000505973771827042,</span></span>
<span><span class="co">#&gt;         "mrc_root" = 1.07281688473608e-05,</span></span>
<span><span class="co">#&gt;         "mrc_grain" = 1e-05,</span></span>
<span><span class="co">#&gt;         "retrans" = 0.9,</span></span>
<span><span class="co">#&gt;         "retrans_rhizome" = 1,</span></span>
<span><span class="co">#&gt;         "rateSeneLeaf" = 0.0124464110871913,</span></span>
<span><span class="co">#&gt;         "rateSeneStem" = 0.000127468732965756,</span></span>
<span><span class="co">#&gt;         "rateSeneRoot" = 0,</span></span>
<span><span class="co">#&gt;         "rateSeneRhizome" = 0,</span></span>
<span><span class="co">#&gt;         "alphaSeneLeaf" = 49.8679276606362,</span></span>
<span><span class="co">#&gt;         "alphaSeneStem" = 3.88965982514793,</span></span>
<span><span class="co">#&gt;         "alphaSeneRoot" = 10,</span></span>
<span><span class="co">#&gt;         "alphaSeneRhizome" = 10,</span></span>
<span><span class="co">#&gt;         "betaSeneLeaf" = -30.2372834250869,</span></span>
<span><span class="co">#&gt;         "betaSeneStem" = -3.3877986715034,</span></span>
<span><span class="co">#&gt;         "betaSeneRoot" = -10,</span></span>
<span><span class="co">#&gt;         "betaSeneRhizome" = -10,</span></span>
<span><span class="co">#&gt;         "remobilization_fraction" = 0.6,</span></span>
<span><span class="co">#&gt;         "soil_depth1" = 0,</span></span>
<span><span class="co">#&gt;         "soil_depth2" = 2.5,</span></span>
<span><span class="co">#&gt;         "soil_depth3" = 10,</span></span>
<span><span class="co">#&gt;         "wsFun" = 2,</span></span>
<span><span class="co">#&gt;         "hydrDist" = 0,</span></span>
<span><span class="co">#&gt;         "rfl" = 0.2,</span></span>
<span><span class="co">#&gt;         "rsdf" = 0.44,</span></span>
<span><span class="co">#&gt;         "phi1" = 0.01,</span></span>
<span><span class="co">#&gt;         "phi2" = 1.5,</span></span>
<span><span class="co">#&gt;         "tbase" = 10,</span></span>
<span><span class="co">#&gt;         "km_leaf_litter" = 2,</span></span>
<span><span class="co">#&gt;         "timestep" = 1</span></span>
<span><span class="co">#&gt;     )</span></span>
<span><span class="co">#&gt; )</span></span></code></pre></div>
<p>It can also be written to a text file:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Save the model definition as an R file in the current working directory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="va">r_cmd_string</span>, <span class="st">'./soybean_reparam.R'</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="commands-from-this-document">Commands From This Document<a class="anchor" aria-label="anchor" href="#commands-from-this-document"></a>
</h2>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">###</span></span>
<span><span class="co">### Preliminaries</span></span>
<span><span class="co">###</span></span>
<span></span>
<span><span class="co"># Load required libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/BioCro/BioCroValidation" class="external-link">BioCroValidation</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/biocro/biocro" class="external-link">BioCro</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">dfoptim</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lattice.r-forge.r-project.org/" class="external-link">lattice</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">###</span></span>
<span><span class="co">### Prepare inputs for `objective_function`</span></span>
<span><span class="co">###</span></span>
<span></span>
<span><span class="co"># Specify the base model definition</span></span>
<span><span class="va">base_model_definition</span>            <span class="op">&lt;-</span> <span class="va">soybean</span></span>
<span><span class="va">base_model_definition</span><span class="op">$</span><span class="va">ode_solver</span> <span class="op">&lt;-</span> <span class="va">default_ode_solvers</span><span class="op">[[</span><span class="st">'homemade_euler'</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Define a helping function for processing data tables</span></span>
<span><span class="va">process_table</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data_table</span>, <span class="va">type</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Define new `time` column</span></span>
<span>  <span class="va">data_table</span><span class="op">$</span><span class="va">time</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">data_table</span><span class="op">$</span><span class="va">DOY</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">24.0</span></span>
<span></span>
<span>  <span class="co"># Define new `Shell_Mg_per_ha` column</span></span>
<span>  <span class="va">data_table</span><span class="op">$</span><span class="va">Shell_Mg_per_ha</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">'biomass'</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># The shell is all parts of the pod other than the seed</span></span>
<span>    <span class="va">data_table</span><span class="op">$</span><span class="va">Rep_Mg_per_ha</span> <span class="op">-</span> <span class="va">data_table</span><span class="op">$</span><span class="va">Seed_Mg_per_ha</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># Add uncertainties in quadrature, a simple approach to error propagation</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">data_table</span><span class="op">$</span><span class="va">Rep_Mg_per_ha</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="va">data_table</span><span class="op">$</span><span class="va">Seed_Mg_per_ha</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Define new `Root_Mg_per_ha` column, which has just one non-NA value</span></span>
<span>  <span class="va">row_to_use</span> <span class="op">&lt;-</span> <span class="fl">5</span>                 <span class="co"># Choose row to use</span></span>
<span>  <span class="va">data_table</span><span class="op">$</span><span class="va">Root_Mg_per_ha</span> <span class="op">&lt;-</span> <span class="cn">NA</span> <span class="co"># Initialize all values to NA</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">'biomass'</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Estimate a mass at one time point</span></span>
<span>    <span class="va">col_to_add</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">'Leaf_Mg_per_ha'</span>,</span>
<span>      <span class="st">'Stem_Mg_per_ha'</span>,</span>
<span>      <span class="st">'Rep_Mg_per_ha'</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="va">data_table</span><span class="op">[</span><span class="va">row_to_use</span>, <span class="st">'Root_Mg_per_ha'</span><span class="op">]</span> <span class="op">&lt;-</span></span>
<span>      <span class="fl">0.17</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">data_table</span><span class="op">[</span><span class="va">row_to_use</span>, <span class="va">col_to_add</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># Estimate standard deviation at one time point</span></span>
<span>    <span class="va">data_table</span><span class="op">[</span><span class="va">row_to_use</span>, <span class="st">'Root_Mg_per_ha'</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1e-5</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Remove columns by setting them to NULL</span></span>
<span>  <span class="va">data_table</span><span class="op">$</span><span class="va">DOY</span>              <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="va">data_table</span><span class="op">$</span><span class="va">Rep_Mg_per_ha</span>    <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="va">data_table</span><span class="op">$</span><span class="va">Litter_Mg_per_ha</span> <span class="op">=</span> <span class="cn">NULL</span></span>
<span></span>
<span>  <span class="co"># Return the processed table</span></span>
<span>  <span class="va">data_table</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Define the data-driver pairs</span></span>
<span><span class="va">data_driver_pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  ambient_2002 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    data       <span class="op">=</span> <span class="fu">process_table</span><span class="op">(</span><span class="va">soyface_biomass</span><span class="op">[[</span><span class="st">'ambient_2002'</span><span class="op">]</span><span class="op">]</span>,     <span class="st">'biomass'</span><span class="op">)</span>,</span>
<span>    data_stdev <span class="op">=</span> <span class="fu">process_table</span><span class="op">(</span><span class="va">soyface_biomass</span><span class="op">[[</span><span class="st">'ambient_2002_std'</span><span class="op">]</span><span class="op">]</span>, <span class="st">'stdev'</span><span class="op">)</span>,</span>
<span>    drivers    <span class="op">=</span> <span class="fu">BioCro</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/BioCro/man/cmi_soybean_weather_data.html" class="external-link">soybean_weather</a></span><span class="op">[[</span><span class="st">'2002'</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    weight     <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span>,</span>
<span>  ambient_2005 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    data       <span class="op">=</span> <span class="fu">process_table</span><span class="op">(</span><span class="va">soyface_biomass</span><span class="op">[[</span><span class="st">'ambient_2005'</span><span class="op">]</span><span class="op">]</span>,     <span class="st">'biomass'</span><span class="op">)</span>,</span>
<span>    data_stdev <span class="op">=</span> <span class="fu">process_table</span><span class="op">(</span><span class="va">soyface_biomass</span><span class="op">[[</span><span class="st">'ambient_2005_std'</span><span class="op">]</span><span class="op">]</span>, <span class="st">'stdev'</span><span class="op">)</span>,</span>
<span>    drivers    <span class="op">=</span> <span class="fu">BioCro</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/BioCro/man/cmi_soybean_weather_data.html" class="external-link">soybean_weather</a></span><span class="op">[[</span><span class="st">'2005'</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    weight     <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define the post-processing function</span></span>
<span><span class="va">post_process_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim_res</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Calculate the total litter as the sum of leaf and stem litter</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">within</a></span><span class="op">(</span><span class="va">sim_res</span>, <span class="op">{</span><span class="va">TotalLitter</span> <span class="op">=</span> <span class="va">LeafLitter</span> <span class="op">+</span> <span class="va">StemLitter</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Define the data definition list, where the element names are columns in the</span></span>
<span><span class="co"># observed data tables, and the element values are the corresponding column</span></span>
<span><span class="co"># names in the model outputs</span></span>
<span><span class="va">data_definitions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span><span class="co"># Observed               Simulated</span></span>
<span>  CumLitter_Mg_per_ha <span class="op">=</span> <span class="st">'TotalLitter'</span>,</span>
<span>  Leaf_Mg_per_ha      <span class="op">=</span> <span class="st">'Leaf'</span>,</span>
<span>  Root_Mg_per_ha      <span class="op">=</span> <span class="st">'Root'</span>,</span>
<span>  Seed_Mg_per_ha      <span class="op">=</span> <span class="st">'Grain'</span>,</span>
<span>  Shell_Mg_per_ha     <span class="op">=</span> <span class="st">'Shell'</span>,</span>
<span>  Stem_Mg_per_ha      <span class="op">=</span> <span class="st">'Stem'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define a list of independent arguments and their initial values</span></span>
<span><span class="va">independent_arg_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="co"># Partitioning for leaf, stem, and shell</span></span>
<span>  <span class="st">'alphaLeaf'</span>,</span>
<span>  <span class="st">'betaLeaf'</span>,</span>
<span>  <span class="st">'alphaStem'</span>,</span>
<span>  <span class="st">'betaStem'</span>,</span>
<span>  <span class="st">'alphaShell'</span>,</span>
<span>  <span class="st">'betaShell'</span>,</span>
<span></span>
<span>  <span class="co"># Senescence for leaf and stem</span></span>
<span>  <span class="st">'alphaSeneLeaf'</span>,</span>
<span>  <span class="st">'betaSeneLeaf'</span>,</span>
<span>  <span class="st">'rateSeneLeaf'</span>,</span>
<span>  <span class="st">'alphaSeneStem'</span>,</span>
<span>  <span class="st">'betaSeneStem'</span>,</span>
<span>  <span class="st">'rateSeneStem'</span>,</span>
<span></span>
<span>  <span class="co"># Growth respiration for stem and root</span></span>
<span>  <span class="st">'grc_stem'</span>,</span>
<span>  <span class="st">'grc_root'</span>,</span>
<span></span>
<span>  <span class="co"># Maintenance respiration for leaf and root</span></span>
<span>  <span class="st">'mrc_leaf'</span>,</span>
<span>  <span class="st">'mrc_root'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">independent_args</span> <span class="op">&lt;-</span> <span class="va">soybean</span><span class="op">$</span><span class="va">parameters</span><span class="op">[</span><span class="va">independent_arg_names</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Define a function that sets `mrc_stem` to the value of `mrc_leaf`</span></span>
<span><span class="va">dependent_arg_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">ind_args</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mrc_stem <span class="op">=</span> <span class="va">ind_args</span><span class="op">[[</span><span class="st">'mrc_leaf'</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Specify the quantity weights; there is no systematic way to determine these,</span></span>
<span><span class="co"># but the following weights have worked well in the past for Soybean-BioCro</span></span>
<span><span class="va">quantity_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  Grain       <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>  Leaf        <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>  Root        <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  Shell       <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>  Stem        <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>  TotalLitter <span class="op">=</span> <span class="fl">0.1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define an extra penalty function</span></span>
<span><span class="va">extra_penalty_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sim_res</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Set the penalty value</span></span>
<span>  <span class="va">PENALTY</span> <span class="op">&lt;-</span> <span class="fl">9999</span></span>
<span></span>
<span>  <span class="co"># Get the first times when each partitioning coefficient becomes non-zero</span></span>
<span>  <span class="va">k_thresh</span> <span class="op">&lt;-</span> <span class="fl">0.01</span> <span class="co"># Threshold k value to decide when growth has started</span></span>
<span>  <span class="va">hpd</span>      <span class="op">&lt;-</span> <span class="fl">24.0</span> <span class="co"># Hours per day</span></span>
<span></span>
<span>  <span class="va">time</span> <span class="op">&lt;-</span> <span class="va">sim_res</span><span class="op">[[</span><span class="st">'time'</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">time_grain</span> <span class="op">&lt;-</span> <span class="va">time</span><span class="op">[</span><span class="va">sim_res</span><span class="op">[[</span><span class="st">'kGrain'</span><span class="op">]</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">k_thresh</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">time_leaf</span>  <span class="op">&lt;-</span> <span class="va">time</span><span class="op">[</span><span class="va">sim_res</span><span class="op">[[</span><span class="st">'kLeaf'</span><span class="op">]</span><span class="op">]</span>  <span class="op">&gt;</span> <span class="va">k_thresh</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">time_shell</span> <span class="op">&lt;-</span> <span class="va">time</span><span class="op">[</span><span class="va">sim_res</span><span class="op">[[</span><span class="st">'kShell'</span><span class="op">]</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">k_thresh</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="va">time_stem</span>  <span class="op">&lt;-</span> <span class="va">time</span><span class="op">[</span><span class="va">sim_res</span><span class="op">[[</span><span class="st">'kStem'</span><span class="op">]</span><span class="op">]</span>  <span class="op">&gt;</span> <span class="va">k_thresh</span><span class="op">]</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span>  <span class="co"># Return a penalty if necessary</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">time_grain</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">time_leaf</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">time_shell</span><span class="op">)</span> <span class="op">|</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">time_stem</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># One or more tissues is not growing</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">PENALTY</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">time_leaf</span> <span class="op">-</span> <span class="va">time_stem</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">5</span> <span class="op">*</span> <span class="va">hpd</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># The starts of leaf and stem growth are more than 5 days apart</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">PENALTY</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">time_leaf</span> <span class="op">-</span> <span class="va">time</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&gt;</span> <span class="fl">20</span> <span class="op">*</span> <span class="va">hpd</span> <span class="op">|</span> <span class="va">time_leaf</span> <span class="op">-</span> <span class="va">time</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">10</span> <span class="op">*</span> <span class="va">hpd</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># The start of leaf growth is too late (more than 20 days after sowing) or</span></span>
<span>    <span class="co"># too early (fewer than 10 days after sowing)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">PENALTY</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># No problems were detected</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fl">0.0</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">###</span></span>
<span><span class="co">### Create the objective function</span></span>
<span><span class="co">###</span></span>
<span></span>
<span><span class="co"># Create the objective function</span></span>
<span><span class="va">obj_fun</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/objective_function.html">objective_function</a></span><span class="op">(</span></span>
<span>  <span class="va">base_model_definition</span>,</span>
<span>  <span class="va">data_driver_pairs</span>,</span>
<span>  <span class="va">independent_args</span>,</span>
<span>  <span class="va">quantity_weights</span>,</span>
<span>  data_definitions       <span class="op">=</span> <span class="va">data_definitions</span>,</span>
<span>  normalization_method   <span class="op">=</span> <span class="st">'mean_max'</span>,</span>
<span>  stdev_weight_method    <span class="op">=</span> <span class="st">'logarithm'</span>,</span>
<span>  stdev_weight_param     <span class="op">=</span> <span class="fl">1e-5</span>,</span>
<span>  regularization_method  <span class="op">=</span> <span class="st">'none'</span>,</span>
<span>  dependent_arg_function <span class="op">=</span> <span class="va">dependent_arg_function</span>,</span>
<span>  post_process_function  <span class="op">=</span> <span class="va">post_process_function</span>,</span>
<span>  extra_penalty_function <span class="op">=</span> <span class="va">extra_penalty_function</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">###</span></span>
<span><span class="co">### Use an optimizer to choose parameter values</span></span>
<span><span class="co">###</span></span>
<span></span>
<span><span class="co"># Set a seed</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Make an initial guess by perturbing the default values by a small amount</span></span>
<span><span class="va">rel_size</span> <span class="op">&lt;-</span> <span class="fl">0.02</span></span>
<span></span>
<span><span class="va">initial_guess</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">independent_args</span><span class="op">)</span> <span class="op">*</span></span>
<span>  <span class="op">(</span><span class="fl">1.0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">independent_args</span><span class="op">)</span>, <span class="op">-</span><span class="va">rel_size</span>, <span class="va">rel_size</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specify some bounds</span></span>
<span><span class="va">aul</span> <span class="op">&lt;-</span> <span class="fl">50</span>   <span class="co"># Upper limit for alpha parameters</span></span>
<span><span class="va">bll</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">50</span>  <span class="co"># Lower limit for beta parameters</span></span>
<span><span class="va">mll</span> <span class="op">&lt;-</span> <span class="fl">1e-6</span> <span class="co"># Lower limit for mrc parameters</span></span>
<span><span class="va">mul</span> <span class="op">&lt;-</span> <span class="fl">1e-2</span> <span class="co"># Upper limit for mrc parameters</span></span>
<span></span>
<span><span class="co"># Define a table with the bounds in the same order as `independent_args`</span></span>
<span><span class="va">bounds</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bounds_table.html">bounds_table</a></span><span class="op">(</span></span>
<span>  <span class="va">independent_args</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    alphaLeaf     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,      <span class="va">aul</span><span class="op">)</span>,</span>
<span>    alphaStem     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,      <span class="va">aul</span><span class="op">)</span>,</span>
<span>    alphaShell    <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,      <span class="va">aul</span><span class="op">)</span>,</span>
<span>    alphaSeneLeaf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,      <span class="va">aul</span><span class="op">)</span>,</span>
<span>    alphaSeneStem <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,      <span class="va">aul</span><span class="op">)</span>,</span>
<span>    betaLeaf      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bll</span>,    <span class="fl">0</span><span class="op">)</span>,</span>
<span>    betaStem      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bll</span>,    <span class="fl">0</span><span class="op">)</span>,</span>
<span>    betaShell     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bll</span>,    <span class="fl">0</span><span class="op">)</span>,</span>
<span>    betaSeneLeaf  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bll</span>,    <span class="fl">0</span><span class="op">)</span>,</span>
<span>    betaSeneStem  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bll</span>,    <span class="fl">0</span><span class="op">)</span>,</span>
<span>    rateSeneLeaf  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,      <span class="fl">0.0125</span><span class="op">)</span>,</span>
<span>    rateSeneStem  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,      <span class="fl">0.005</span><span class="op">)</span>,</span>
<span>    mrc_leaf      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mll</span>,    <span class="va">mul</span><span class="op">)</span>,</span>
<span>    mrc_root      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">mll</span>,    <span class="va">mul</span><span class="op">)</span>,</span>
<span>    grc_stem      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">8e-4</span>,   <span class="fl">0.08</span><span class="op">)</span>,</span>
<span>    grc_root      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.0025</span>, <span class="fl">0.075</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="va">initial_guess</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the optimizer</span></span>
<span><span class="va">optim_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/dfoptim/man/nmkb.html" class="external-link">nmkb</a></span><span class="op">(</span></span>
<span>  <span class="va">initial_guess</span>,</span>
<span>  <span class="va">obj_fun</span>,</span>
<span>  <span class="va">bounds</span><span class="op">[[</span><span class="st">'lower'</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="va">bounds</span><span class="op">[[</span><span class="st">'upper'</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    tol <span class="op">=</span> <span class="fl">1e-2</span>,</span>
<span>    restarts.max <span class="op">=</span> <span class="fl">10</span></span>
<span>  <span class="op">)</span>,</span>
<span>  debug_mode <span class="op">=</span> <span class="cn">FALSE</span> <span class="co"># Passed to obj_fun; set to TRUE to enable debug mode</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">###</span></span>
<span><span class="co">### Check and record the new values</span></span>
<span><span class="co">###</span></span>
<span></span>
<span><span class="co"># Create a table of the various independent argument values</span></span>
<span><span class="va">ind_arg_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  arg_name      <span class="op">=</span> <span class="va">independent_arg_names</span>,</span>
<span>  defaults      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">independent_args</span><span class="op">)</span>,</span>
<span>  initial_guess <span class="op">=</span> <span class="va">initial_guess</span>,</span>
<span>  optimized     <span class="op">=</span> <span class="va">optim_res</span><span class="op">[[</span><span class="st">'par'</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Add differences</span></span>
<span><span class="va">ind_arg_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">within</a></span><span class="op">(</span><span class="va">ind_arg_table</span>, <span class="op">{</span></span>
<span>  <span class="va">initial_diff</span>   <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">initial_guess</span> <span class="op">-</span> <span class="va">defaults</span><span class="op">)</span></span>
<span>  <span class="va">optimized_diff</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">optimized</span> <span class="op">-</span> <span class="va">defaults</span><span class="op">)</span></span>
<span>  <span class="va">improved</span>       <span class="op">=</span> <span class="va">optimized_diff</span> <span class="op">&lt;</span> <span class="va">initial_diff</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">ind_arg_table</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get model definition lists for the perturbed and re-parameterized versions of</span></span>
<span><span class="co"># the soybean model</span></span>
<span><span class="va">soybean_perturbed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_model.html">update_model</a></span><span class="op">(</span></span>
<span>  <span class="fu">BioCro</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/BioCro/man/soybean.html" class="external-link">soybean</a></span>,</span>
<span>  <span class="va">independent_args</span>,</span>
<span>  <span class="va">initial_guess</span>,</span>
<span>  dependent_arg_function <span class="op">=</span> <span class="va">dependent_arg_function</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">soybean_reparam</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_model.html">update_model</a></span><span class="op">(</span></span>
<span>  <span class="fu">BioCro</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/BioCro/man/soybean.html" class="external-link">soybean</a></span>,</span>
<span>  <span class="va">independent_args</span>,</span>
<span>  <span class="va">optim_res</span><span class="op">[[</span><span class="st">'par'</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  dependent_arg_function <span class="op">=</span> <span class="va">dependent_arg_function</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define a helper function that runs a single model for the year 2005</span></span>
<span><span class="va">run_2005</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model_definition</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">model_definition</span>, <span class="op">{</span><span class="fu"><a href="https://rdrr.io/pkg/BioCro/man/run_biocro.html" class="external-link">run_biocro</a></span><span class="op">(</span></span>
<span>    <span class="va">initial_values</span>,</span>
<span>    <span class="va">parameters</span>,</span>
<span>    <span class="va">soybean_weather</span><span class="op">[[</span><span class="st">'2005'</span><span class="op">]</span><span class="op">]</span>,</span>
<span>    <span class="va">direct_modules</span>,</span>
<span>    <span class="va">differential_modules</span>,</span>
<span>    <span class="va">ode_solver</span></span>
<span>  <span class="op">)</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Run each model and combine the results</span></span>
<span><span class="va">full_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">within</a></span><span class="op">(</span><span class="fu">run_2005</span><span class="op">(</span><span class="fu">BioCro</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/BioCro/man/soybean.html" class="external-link">soybean</a></span><span class="op">)</span>,   <span class="op">{</span><span class="va">model</span> <span class="op">=</span> <span class="st">'Default Soybean-BioCro'</span><span class="op">}</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">within</a></span><span class="op">(</span><span class="fu">run_2005</span><span class="op">(</span><span class="va">soybean_perturbed</span><span class="op">)</span>, <span class="op">{</span><span class="va">model</span> <span class="op">=</span> <span class="st">'Perturbed Soybean-BioCro'</span><span class="op">}</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">within</a></span><span class="op">(</span><span class="fu">run_2005</span><span class="op">(</span><span class="va">soybean_reparam</span><span class="op">)</span>,   <span class="op">{</span><span class="va">model</span> <span class="op">=</span> <span class="st">'Re-parameterized Soybean-BioCro'</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the results</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/lattice/man/xyplot.html" class="external-link">xyplot</a></span><span class="op">(</span></span>
<span>  <span class="va">Leaf</span> <span class="op">+</span> <span class="va">Stem</span> <span class="op">+</span> <span class="va">Root</span> <span class="op">+</span> <span class="va">Grain</span> <span class="op">~</span> <span class="va">fractional_doy</span>,</span>
<span>  group <span class="op">=</span> <span class="va">model</span>,</span>
<span>  data <span class="op">=</span> <span class="va">full_res</span>,</span>
<span>  type <span class="op">=</span> <span class="st">'l'</span>,</span>
<span>  auto.key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>space <span class="op">=</span> <span class="st">'top'</span><span class="op">)</span>,</span>
<span>  xlab <span class="op">=</span> <span class="st">'Day of year (2005)'</span>,</span>
<span>  ylab <span class="op">=</span> <span class="st">'Biomass (Mg / ha)'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert the re-parameterized soybean model to an R command string</span></span>
<span><span class="va">r_cmd_string</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">soybean_reparam</span>, <span class="fu"><a href="../reference/write_model.html">write_model</a></span><span class="op">(</span></span>
<span>  <span class="st">'soybean_reparam'</span>,</span>
<span>  <span class="va">direct_modules</span>,</span>
<span>  <span class="va">differential_modules</span>,</span>
<span>  <span class="va">initial_values</span>,</span>
<span>  <span class="va">parameters</span>,</span>
<span>  <span class="va">ode_solver</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Save the model definition as an R file in the current working directory</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/writeLines.html" class="external-link">writeLines</a></span><span class="op">(</span><span class="va">r_cmd_string</span>, <span class="st">'./soybean_reparam.R'</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-lochocki_biocro_2022" class="csl-entry">
Lochocki, Edward B, Scott Rohde, Deepak Jaiswal, Megan L Matthews,
Fernando Miguez, Stephen P Long, and Justin M McGrath. 2022.
<span>“BioCro II: A Software Package for Modular Crop Growth
Simulations.”</span> <em>In Silico Plants</em> 4 (1): diac003. <a href="https://doi.org/10.1093/insilicoplants/diac003" class="external-link">https://doi.org/10.1093/insilicoplants/diac003</a>.
</div>
<div id="ref-matthews_soybean_biocro_2021" class="csl-entry">
Matthews, Megan L, Amy Marshall-Colón, Justin M McGrath, Edward B
Lochocki, and Stephen P Long. 2021. <span>“Soybean-BioCro: A
Semi-Mechanistic Model of Soybean Growth.”</span> <em>In Silico
Plants</em> 4 (1): diab032. <a href="https://doi.org/10.1093/insilicoplants/diab032" class="external-link">https://doi.org/10.1093/insilicoplants/diab032</a>.
</div>
<div id="ref-ordonez_root_2020" class="csl-entry">
Ordóñez, Raziel A., Sotirios V. Archontoulis, Rafael Martinez-Feria,
Jerry L. Hatfield, Emily E. Wright, and Michael J. Castellano. 2020.
<span>“Root to Shoot and Carbon to Nitrogen Ratios of Maize and Soybean
Crops in the <span>US</span> <span>Midwest</span>.”</span> <em>European
Journal of Agronomy</em> 120 (October): 126130. <a href="https://doi.org/10.1016/j.eja.2020.126130" class="external-link">https://doi.org/10.1016/j.eja.2020.126130</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Edward B. Lochocki.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
